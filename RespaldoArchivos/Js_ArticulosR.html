<script>
(function() {
    // =================================================
    // --- VARIABLES DE ESTADO DE LA PÁGINA
    // =================================================
    const pageState = {
        fullData: [],
        datosMostrados: [],
        currentPage: 1,
        itemsPerPage: 10,
        productoAEditarId: null,
        productoRetiroSeleccionado: null,
        fechaOrdenAscendente: false,
        productoComentarioSeleccionado: null,
        productosViejosGlobal: [],
        paginaActualNotificaciones: 1,
        elementosPorPaginaNotificaciones: 10,
    };

// ===================================
// --- FUNCIONES DE MANEJO DE MODALES ---
// ===================================
function abrirModalAgregar() {
    abrirModal("modalAgregar");
    document.getElementById("agregarForm").reset();
}
function cerrarModalAgregar() {
    cerrarModal("modalAgregar");
}

function abrirModalRetiro(id, producto, programa, unidadesDisponibles) {
    pageState.productoRetiroSeleccionado = { id, producto, programa, unidadesDisponibles };
    abrirModal("modalRetiro");
    document.getElementById("productoIdRetiro").textContent = pageState.productoRetiroSeleccionado.id;
    document.getElementById("productoNombreRetiro").textContent = pageState.productoRetiroSeleccionado.producto;
    document.getElementById("programaRetiro").textContent = pageState.productoRetiroSeleccionado.programa;
    document.getElementById("unidadesDisponiblesRetiro").textContent = pageState.productoRetiroSeleccionado.unidadesDisponibles;
    document.getElementById("unidadesRetirar").value = "";  
    document.getElementById("unidadesRetirar").max = pageState.productoRetiroSeleccionado.unidadesDisponibles; 
}
function cerrarModalRetiro() {
    cerrarModal("modalRetiro");
    document.getElementById("retiroForm").reset();
    pageState.productoRetiroSeleccionado = null;
}

function abrirModalEditar(id) {
    pageState.productoAEditarId = id;
    const producto = pageState.datosMostrados.find(item => String(item.Id) === String(id)); 
    if (producto) {
        abrirModal("modalEditar");
        document.getElementById("productoIdEditar").textContent = id;
        document.getElementById("productoEditar").value = producto["PRODUCTO"];
        document.getElementById("programaEditar").value = producto["PROGRAMA"];
        document.getElementById("unidadesAgregarEditar").value = "0"; 
        document.getElementById("imagenEditar").value = producto["Imagen"] || "";
    } else {
        console.error("No se encontró el producto con ID:", id, "en datosMostrados para editar.");
        mostrarMensaje("Error: No se pudo encontrar el producto para editar.", "error");
    }
}
function cerrarModalEditar() {
    cerrarModal("modalEditar");
    document.getElementById("editarForm").reset();
    pageState.productoAEditarId = null;
}

function abrirModalComentario(id, producto, programa) {
    pageState.productoComentarioSeleccionado = { id, producto, programa };
    abrirModal("modalComentario");
    document.getElementById("comentarioProductoId").textContent = pageState.productoComentarioSeleccionado.id;
    document.getElementById("comentarioProductoNombre").textContent = pageState.productoComentarioSeleccionado.producto;
    document.getElementById("comentarioProductoPrograma").textContent = pageState.productoComentarioSeleccionado.programa;
    const comentarioTextoInput = document.getElementById("comentarioTexto");
    if (comentarioTextoInput) {
        comentarioTextoInput.value = "";
    }
    else{
        console.error('No se encontró el elemento con el ID "comentarioTexto".',id);
        mostrarMensaje('Error: No se pudo encontrar el elemento para comentar.', 'error');
    }
    
}
function cerrarModalComentario() {
    cerrarModal("modalComentario");
    document.getElementById("comentarioForm").reset();
    pageState.productoComentarioSeleccionado = null;
}

function abrirModalNotificacionesInterno() {
    abrirModal("modalNotificaciones");
    cargarNotificacionesNuevas();
}
function cerrarModalNotificaciones() {
    cerrarModal("modalNotificaciones");
}

function abrirModalVerImagen(imageUrl) {
    const modal = document.getElementById("modalVerImagen");
    const imgElement = document.getElementById("imagenEnModal");
    if (modal && imgElement) {
        if (imageUrl && imageUrl.trim() !== '') {
            imgElement.src = imageUrl;
            abrirModal("modalVerImagen");
        } else {
            mostrarMensaje('No hay URL de imagen para mostrar.', 'info');
        }
    }
}
function cerrarModalVerImagen() {
    cerrarModal("modalVerImagen");
    document.getElementById("imagenEnModal").src = "";
}
function abrirImagenNuevaVentana(imageUrl) {
    if (imageUrl && imageUrl.trim() !== "") {
        window.open(imageUrl, '_blank');
    } else {
        mostrarMensaje('No hay imagen disponible para abrir.', 'info');
    }
}

// =======================================
// --- MANEJO DE DATOS Y LLAMADAS AL SERVIDOR ---
// =======================================
function loadInventario() {
    loadDataGenerico({
        endpoint: "getInventarioData",
        tbodyId: "tablaBody",
        noDataId: "noData",
        containerId: "tableContainer",
        onSuccess: function(data) {
            pageState.fullData = data;
            pageState.currentPage = 1;
            aplicarFiltrosYOrdenar();
            if (pageState.fullData.length === 0) {
                document.getElementById("noData").style.display = "block";
                document.getElementById("tableContainer").style.display = "none";
            } else {
                document.getElementById("noData").style.display = "none";
                document.getElementById("tableContainer").style.display = "block";
            }
        }
    });
}

function confirmarEliminar(id, nombreProducto) {
    if (confirm(`¿Seguro que deseas desactivar el producto "${nombreProducto}"? Esta acción no se puede deshacer fácilmente.`)) {
        showLoading(true);
        google.script.run
            .withSuccessHandler(function (responseString) {
                hideLoading();
                let response;
                try {
                    response = JSON.parse(responseString);
                    if (response.success) {
                         mostrarMensaje(response.message, 'success');
                         loadInventario();
                    } else {
                        mostrarMensaje("Error: " + (response.message || "No se pudo eliminar."), 'error');
                    }
                } catch(e) {
                    mostrarMensaje(responseString, responseString.toLowerCase().includes('error') ? 'error' : 'success');
                    if (!responseString.toLowerCase().includes('error')) {
                        loadInventario();
                    }
                }
            })
            .withFailureHandler(function (error) {
                hideLoading();
                console.error("Error eliminando producto:", error);
                mostrarMensaje("Error al eliminar producto: " + error.message, 'error');
            })
            .eliminarProductoInventario(id);
    }
}
function handleServerResponse(response) {
  showLoading(false);
  let parsedResponse;
  try {
    parsedResponse = typeof response === 'string' ? JSON.parse(response) : response;
  } catch (e) {
    console.error("Error parseando respuesta del servidor a JSON:", e, "Respuesta original:", response);
    const message = "Error: Respuesta inesperada del servidor (formato inválido).";
    mostrarMensaje(message, "error");
    showToastNotification(message, "error");
    document.getElementById('imagenArchivoAgregar').value = "";
    return;
  }
  if (parsedResponse && typeof parsedResponse.success !== 'undefined') {
    if (parsedResponse.success) {
      const message = parsedResponse.message || 'Operación completada exitosamente.';
      mostrarMensaje(message, 'success');
      showToastNotification(message, 'success');
      loadInventario();
      if (document.getElementById('modalAgregar').style.display === 'block') cerrarModalAgregar();
      if (document.getElementById('modalEditar').style.display === 'block') cerrarModalEditar();
      if (document.getElementById('modalRetiro').style.display === 'block') cerrarModalRetiro();
      if (document.getElementById('modalComentario').style.display === 'block') cerrarModalComentario();
    } else {
      const message = 'Error: ' + (parsedResponse.message || 'Ocurrió un error desconocido.');
      mostrarMensaje(message, 'error');
      showToastNotification(message, 'error');
    }
  } else {
      console.error("Respuesta JSON del servidor con formato inesperado (falta 'success' o es nula):", parsedResponse);
      const message = "Error: Respuesta inesperada del servidor (estructura inválida).";
      mostrarMensaje(message, "error");
      showToastNotification(message, "error");
  }
  document.getElementById('imagenArchivoAgregar').value = ""; 
}
function handleServerError(error) {
  showLoading(false);
  console.error('Error en la llamada al servidor:', error);
  const message = 'Error de comunicación con el servidor: ' + error.message;
  mostrarMensaje(message, 'error');
  showToastNotification(message, 'error');
  document.getElementById('imagenArchivoAgregar').value = ""; 
}
// =========================================
// --- MANEJADORES DE ENVÍO DE FORMULARIOS ---
// =========================================
document.getElementById("agregarForm").addEventListener("submit", function (e) {
    e.preventDefault();
    showLoading(true);
    const productoAgregar = document.getElementById("productoAgregar").value.trim();
    const programaAgregar = document.getElementById("programaAgregar").value.trim();
    const ingresosAgregar = document.getElementById("ingresosAgregar").value;
    const imagenArchivoInput = document.getElementById("imagenArchivoAgregar");
    const imagenFile = imagenArchivoInput.files[0];
    if (!productoAgregar || !programaAgregar || ingresosAgregar === '' || parseFloat(ingresosAgregar) < 0) {
        mostrarMensaje('Por favor, complete todos los campos obligatorios con valores válidos.', 'error');
        showLoading(false);
        return;
    }
    const productData = {
        productoAgregar: productoAgregar,
        programaAgregar: programaAgregar,
        ingresosAgregar: parseFloat(ingresosAgregar),
    };
    if (imagenFile) {
        if (imagenFile.size > 5 * 1024 * 1024) { 
            mostrarMensaje('El archivo de imagen es demasiado grande (máximo 5MB).', 'error');
            showLoading(false);
            imagenArchivoInput.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(event) {
            const base64Data = event.target.result.split(',')[1];
            const fileData = {
                base64Data: base64Data,
                mimeType: imagenFile.type,
                fileName: imagenFile.name
            };
            google.script.run
                .withSuccessHandler(handleServerResponse)
                .withFailureHandler(handleServerError)
                .agregarProductoConImagenDesdeArchivo(productData, fileData); 
        };
        reader.onerror = function (error) {
            showLoading(false);
            console.error('Error leyendo el archivo:', error);
            mostrarMensaje('Error al leer el archivo de imagen.', 'error');
            imagenArchivoInput.value = '';
        };
        reader.readAsDataURL(imagenFile);
    } else {
        const dataSinImagen = { ...productData, imagenAgregar: "" };
        google.script.run
            .withSuccessHandler(handleServerResponse)
            .withFailureHandler(handleServerError)
            .agregarProductoInventario(dataSinImagen);
    }
});
document.getElementById("editarForm").addEventListener("submit", function (e) {
    e.preventDefault();
    showLoading(true);
    const productoEditar = document.getElementById('productoEditar').value.trim();
    const programaEditar = document.getElementById('programaEditar').value.trim();
    const unidadesAgregarEditar = document.getElementById('unidadesAgregarEditar').value;
    const imagenEditar = document.getElementById('imagenEditar').value.trim();
    if (!productoEditar || !programaEditar || unidadesAgregarEditar === '' || parseFloat(unidadesAgregarEditar) < 0 ) {
        mostrarMensaje('Por favor, complete todos los campos obligatorios para editar.', 'error');
        showLoading(false);
        return;
    }
    const data = {
        idEditar: productoAEditarId,
        productoEditar: productoEditar,
        programaEditar: programaEditar,
        unidadesAgregarEditar: parseFloat(unidadesAgregarEditar),
        imagenEditar: imagenEditar,
    };
    google.script.run
        .withSuccessHandler(handleServerResponse)
        .withFailureHandler(handleServerError)
        .actualizarProductoInventario(data);
});
document.getElementById("retiroForm").addEventListener("submit", function (e) {
    e.preventDefault();
    showLoading(true);
    if (!pageState.productoRetiroSeleccionado) {
        mostrarMensaje("No se ha seleccionado ningún producto para retirar.", 'error');
        showLoading(false);
        return;
    }
    const unidadesRetirarInput = document.getElementById("unidadesRetirar");
    const unidadesRetirar = parseInt(unidadesRetirarInput.value);
    const unidadesDisponibles = parseInt(pageState.productoRetiroSeleccionado.unidadesDisponibles);
    if (isNaN(unidadesRetirar) || unidadesRetirar <= 0) {
        mostrarMensaje("Por favor, ingrese una cantidad válida para retirar.", 'error');
        showLoading(false);
        return;
    }
    if (unidadesRetirar > unidadesDisponibles) {
        mostrarMensaje(`No se pueden retirar ${unidadesRetirar} unidades. Solo hay ${unidadesDisponibles} disponibles.`, 'error');
        showLoading(false);
        return;
    }
    google.script.run
        .withSuccessHandler(handleServerResponse)
        .withFailureHandler(handleServerError)
        .retirarProductoInventario(pageState.productoRetiroSeleccionado.id, unidadesRetirar);
});
document.getElementById("comentarioForm").addEventListener("submit", function (e) {
    e.preventDefault();
    showLoading();
    if (!pageState.productoComentarioSeleccionado) {
        hideLoading();
        mostrarMensaje("No se ha seleccionado ningún producto para comentar.", "error");
        return;
    }
    const comentarioData = {
        idComentario: pageState.productoComentarioSeleccionado.id,
        comentarioTexto: document.getElementById("comentarioTexto").value,
    };
    google.script.run
        .withSuccessHandler(function (responseString) {
            hideLoading();
            cerrarModalComentario();
            let response;
            try {
                response = JSON.parse(responseString);
                if (response.success) {
                    mostrarMensaje(response.message || 'Comentario agregado exitosamente.', 'success');
                    loadInventario(); 
                } else {
                    mostrarMensaje('Error al agregar comentario: ' + (response.message || 'Desconocido.'), 'error');
                }
            } catch (e) {
                console.error("Error parseando respuesta de comentario:", e, responseString);
                mostrarMensaje('Error al procesar la respuesta del comentario.', 'error');
            }
        })
        .withFailureHandler(function (error) {
            hideLoading();
            console.error("Error registering comment:", error);
            mostrarMensaje("Error al registrar comentario.", "error");
        })
        .agregarComentarioInventario(comentarioData); 
});
// =========================================
// --- FUNCIONES DE FILTRADO Y ORDENAMIENTO ---
// =========================================
function aplicarFiltrosYOrdenarArticulos() {
    aplicarFiltrosYOrdenarGenerico({
        dataSource: pageState.fullData,
        setResultados: val => { 
            pageState.datosMostrados = val; 
            pageState.currentPage = 1; 
        },
        fechaOrdenAsc: pageState.fechaOrdenAscendente,
        renderFn: renderPaginatedTable,
        filters: [
            { id: "buscarProducto", field: "PRODUCTO", type: "text" },
            { id: "filtroPrograma", field: "PROGRAMA", type: "text" },
            { id: "filtroFechaIngreso", field: "FECHA DE INGRESO", type: "date" },
            { id: "filtroUnidades", field: "Unidades disponibles", type: "number" },
            { id: "filtroTiempoStorage", field: "Tiempo en Storage", type: "number" },
            { id: "filtroEstado", field: "Estado", type: "text" }
        ]
    });
}

const aplicarFiltrosYOrdenar = aplicarFiltrosYOrdenarArticulos;
function limpiarTodosLosFiltrosArticulos() {
    limpiarFiltrosGenerico({
        filtros: [
            { id: "buscarProducto", type: "text" },
            { id: "filtroPrograma", type: "text" },
            { id: "filtroFechaIngreso", type: "date" },
            { id: "filtroUnidades", type: "number" },
            { id: "filtroTiempoStorage", type: "number" },
            { id: "filtroEstado", type: "select", defaultValue: "activo" }
        ],
        aplicarFn: aplicarFiltrosYOrdenarArticulos
    });
}

function searchItemsArticulos() {
    searchItemsGenerico(aplicarFiltrosYOrdenarArticulos);
}

function clearSearchArticulos() {
    clearSearchGenerico("buscarProducto", aplicarFiltrosYOrdenarArticulos);
}

function ordenarPorFechaArticulos(event) {
    ordenarPorFechaGenerico(event, "sortOptions");
}

function ordenarAscendenteArticulos() {
    ordenarAscendenteGenerico(aplicarFiltrosYOrdenarArticulos, "sortOptions", val => pageState.fechaOrdenAscendente = val);
}

function ordenarDescendenteArticulos() {
    ordenarDescendenteGenerico(aplicarFiltrosYOrdenarArticulos, "sortOptions", val => pageState.fechaOrdenAscendente = val);
}

function toggleFiltrosAdicionalesArticulos() {
    toggleFiltrosAdicionalesGenerico("filtrosAdicionalesContainer");
}

// Registrar cierre de modales con ESC
registrarEscapeCierraModales([
    cerrarModalAgregar,
    cerrarModalEditar,
    cerrarModalRetiro,
    cerrarModalComentario,
    cerrarModalNotificaciones
]);

// ============================================
// --- RENDERIZADO DE TABLA Y PAGINACIÓN ---
// ============================================

function renderPaginatedTable() {
    const tbody = document.getElementById("tablaBody");
    tbody.innerHTML = "";
    if (pageState.datosMostrados.length === 0) {
        tbody.innerHTML = "<tr><td colspan='13' style='text-align:center;'>No hay productos que coincidan con los filtros.</td></tr>";
        document.getElementById("pagination").innerHTML = ""; 
        return;
    }
    const totalPages = Math.ceil(pageState.datosMostrados.length / pageState.itemsPerPage);
  if (pageState.currentPage > totalPages) {
    pageState.currentPage = 1;
  }
const start = (pageState.currentPage - 1) * pageState.itemsPerPage;
    const paginatedItems = pageState.datosMostrados.slice(start, start + pageState.itemsPerPage);
    paginatedItems.forEach(item => {
        const row = tbody.insertRow(); 
        const unidades = parseInt(item["Unidades disponibles"]);
        const agotadoClass = unidades === 0 ? "agotado" : "";
        const imageUrl = item["Imagen"] || "";
        const fechaIngresoFormateada = formatDate(item["FECHA DE INGRESO"]);
        const entregaFechaFormateada = formatDate(item["Entregas fecha"]);
        row.innerHTML = `
            <td>${item["Id"] || ''}</td>
            <td>${item["PRODUCTO"] || ''}</td>
            <td>${item["PROGRAMA"] || ''}</td>
            <td>${fechaIngresoFormateada}</td>
            <td>${item["Ingresos"] || 0}</td>
            <td>${item["Salidas"] || 0}</td>
            <td class="${agotadoClass}">${unidades}</td>
            <td>${item["Tiempo en Storage"] == null ? '' : item["Tiempo en Storage"]}</td>
            <td>
                ${imageUrl ?
                        `<span>
                            <ion-icon 
                                name="open-outline" 
                                class="btn-icon" 
                                title="Abrir imagen en nueva pestaña" 
                                style="font-size: 22px; vertical-align: middle; color: #007bff; cursor: pointer;"
                                onclick="abrirImagenNuevaVentana('${imageUrl}')">
                            </ion-icon>
                        </span>` :
                        'N/A'
                        }
            </td>
            <td>${entregaFechaFormateada}</td>
            <td>${item["Entregas cantidad"] || ''}</td>
            <td>${item["Estado"] || ''}</td>
            <td>
                <button class="btn-modificar" title="Editar" onclick="abrirModalEditar('${item["Id"]}')"><ion-icon name="create-outline" class="btn-icon"></ion-icon></button>
                <button class="btn-retirar" title="Retirar" onclick="abrirModalRetiro('${item["Id"]}', '${item["PRODUCTO"]}', '${item["PROGRAMA"]}', ${item["Unidades disponibles"]})"><ion-icon name="bag-handle-outline" class="btn-icon"></ion-icon></button>
                <button class="btn-comentario" title="Comentar" onclick="abrirModalComentario('${item["Id"]}', '${item["PRODUCTO"]}', '${item["PROGRAMA"]}')"><ion-icon name="chatbubble-ellipses-outline" class="btn-icon"></ion-icon></button>
                <button class="btn-eliminar" title="Desactivar" onclick="confirmarEliminar('${item["Id"]}', '${escapeHtml(item["PRODUCTO"])}')"><ion-icon name="trash-bin-outline" class="btn-icon"></ion-icon></button>
            </td>
        `;
        
    });
    renderPaginationControls(pageState.datosMostrados.length);
}
function renderPaginationControls(totalItems) {
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = "";

    const totalPages = Math.ceil(totalItems / pageState.itemsPerPage);
    if (totalPages <= 1) return;

    const maxButtons = 5;
    let buttonsHtml = '';

    buttonsHtml += `<button class="page-btn" onclick="changePage(pageState.currentPage - 1)" ${pageState.currentPage === 1 ? "disabled" : ""}>Anterior</button>`;

    let startPage = Math.max(1, pageState.currentPage - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);

    if (endPage === totalPages) {
        startPage = Math.max(1, totalPages - maxButtons + 1);
    }

    if (startPage > 1) {
        buttonsHtml += `<button class="page-btn" onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
            buttonsHtml += `<span class="pagination-dots">...</span>`;
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === pageState.currentPage ? "active" : "";
        buttonsHtml += `<button class="page-btn ${activeClass}" onclick="changePage(${i})">${i}</button>`;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            buttonsHtml += `<span class="pagination-dots">...</span>`;
        }
        buttonsHtml += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    buttonsHtml += `<button class="page-btn" onclick="changePage(pageState.currentPage + 1)" ${pageState.currentPage === totalPages ? "disabled" : ""}>Siguiente</button>`;
    paginationDiv.innerHTML = buttonsHtml;
}
function changePage(page) {
    const totalPages = Math.ceil(pageState.datosMostrados.length / pageState.itemsPerPage);
    pageState.currentPage = Math.max(1, Math.min(page, totalPages || 1));
    renderPaginatedTable();
}
// ============================================
// --- FUNCIONES DE NOTIFICACIONES (PRODUCTOS ANTIGUOS) ---
// ============================================

function cargarNotificacionesNuevas() {
    showLoading(true);
    google.script.run
        .withSuccessHandler(function (productosServerString) {
            hideLoading();
            try {
                const productosServer = JSON.parse(productosServerString);
                if (Array.isArray(productosServer)) {
                    pageState.productosViejosGlobal = productosServer;
                    pageState.paginaActualNotificaciones = 1; 
                    renderizarTablaNotificaciones(); 
                    updateNotificationIcon();
                    mostrarMensaje('Notificaciones actualizadas correctamente.', 'success');
                } else {
                    console.error('Formato de respuesta inesperado de getArticulosViejos (no es un array después de parsear):', productosServer);
                    mostrarMensaje('Error: Formato de datos de notificaciones incorrecto.', 'error');
                }
            } catch (e) {
                hideLoading();
                console.error('Error parseando la respuesta de getArticulosViejos:', e, productosServerString);
                mostrarMensaje('Error al procesar los datos de notificaciones.', 'error');
            }
        })
        .withFailureHandler(function (error) {
            hideLoading();
            console.error('Error al obtener productos viejos:', error);
            mostrarMensaje('Error de comunicación al cargar notificaciones: ' + error.message, 'error');
        })
        .getArticulosViejos(); 
}
// Archivo: Js_Articulos.html
function renderizarTablaNotificaciones() {
    const tablaBody = document.getElementById("tablaBodyNotificaciones");
    if (!tablaBody) return;
    tablaBody.innerHTML = '';

    const start = (pageState.paginaActualNotificaciones - 1) * pageState.elementosPorPaginaNotificaciones;
    const end = start + pageState.elementosPorPaginaNotificaciones;
    const itemsParaMostrar = pageState.productosViejosGlobal.slice(start, end);

    if (itemsParaMostrar.length === 0) {
        tablaBody.innerHTML = `<tr><td colspan="6" class="no-data">No hay notificaciones de productos vencidos.</td></tr>`;
    } else {
        itemsParaMostrar.forEach(item => {
            const row = document.createElement('tr');

            // ID ya normalizado en minúsculas
            const itemId = item.id ? String(item.id).trim() : "";

            // Tiempo en storage viene en días → convertir a meses
            const tiempoEnStorageDias = parseInt(item.tiempoenstorage) || 0;
            const tiempoEnStorageMeses = Math.floor(tiempoEnStorageDias / 30);

            // Chequear vencimiento (>= 8 meses)
            const esVencido = tiempoEnStorageMeses >= 8;
            row.classList.toggle('producto-viejo-critico', esVencido);

            row.innerHTML = `
              
                <td>${escapeHtml(itemId || "N/A")}</td>
                <td>${escapeHtml(item.producto || "N/A")}</td>
                <td>${escapeHtml(item.programa || "N/A")}</td>
                <td>${formatDate(item.fechadeingreso)}</td>
                <td>
                    ${tiempoEnStorageMeses >= 8 
                        ? `<span class="producto-viejo-critico">⚠ ${escapeHtml(String(tiempoEnStorageMeses))} meses</span>` 
                        : `${escapeHtml(String(tiempoEnStorageMeses))} meses`}
                </td>
                 <td>
                    <input type="checkbox" 
                           data-id="${escapeHtml(itemId)}"  
                           class="select-notification-checkbox"  
                           onchange="handleIndividualCheckboxChange()">
                </td>
            `;
            tablaBody.appendChild(row);
        });
    }
    actualizarControlesPaginacionNotificaciones();
}



function updateNotificationIcon() {
    const notificacionCampanaIcon = document.getElementById("notificacionCampanaIcon");
    const notificacionCampanaCount = document.getElementById("notificacionCampanaCount");
    if (notificacionCampanaIcon && notificacionCampanaCount) {
        if (pageState.productosViejosGlobal.length > 0) {
            notificacionCampanaCount.textContent = pageState.productosViejosGlobal.length;
            notificacionCampanaCount.style.display = "inline-block";
            notificacionCampanaIcon.style.cursor = "pointer";
            notificacionCampanaIcon.onclick = abrirModalNotificacionesInterno;
        } else {
            notificacionCampanaCount.style.display = "none";
            notificacionCampanaIcon.style.cursor = "default";
            notificacionCampanaIcon.onclick = null;
        }
    }
}

function handleIndividualCheckboxChange() {
    const allCheckboxes = document.querySelectorAll('#tablaBodyNotificaciones .select-notification-checkbox');
    const checkedCheckboxes = document.querySelectorAll('#tablaBodyNotificaciones .select-notification-checkbox:checked');
    const selectAllCheckbox = document.getElementById('selectAllNotifications');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
    }
}

function deactivateSelectedNotifications() {
    const checkboxes = document.querySelectorAll('#tablaBodyNotificaciones .select-notification-checkbox:checked');
    if (checkboxes.length === 0) {
        mostrarMensaje("Selecciona al menos un producto para dar de baja.", "error");
        return;
    }
    const idsToDeactivate = Array.from(checkboxes)
        .map(cb => cb.dataset.id)
        .filter(id => id && id.trim() !== ''); // Filtra IDs vacíos o nulos

    if (idsToDeactivate.length === 0) {
        mostrarMensaje("No se pudo obtener el ID de los productos seleccionados. La operación fue cancelada.", "error");
        return;
    }

    if (confirm(`¿Está seguro de que desea dar de baja ${idsToDeactivate.length} producto(s)? Esta acción los desactivará.`)) {
        showLoading(true);
        google.script.run
            .withSuccessHandler(function (responseString) {
                hideLoading();
                let response;
                try {
                    response = JSON.parse(responseString);
                    if (response.success) {
                        mostrarMensaje(response.message || 'Producto(s) dado(s) de baja exitosamente.', 'success');
                        loadInventario(); 
                        cerrarModalNotificaciones(); 
                    } else {
                        mostrarMensaje('Error al dar de baja producto(s): ' + (response.message || 'Desconocido.'), 'error');
                    }
                } catch (e) {
                    console.error('Error parseando respuesta de desactivación:', e, responseString);
                    mostrarMensaje('Error al procesar la respuesta de desactivación.', 'error');
                }
            })
            .withFailureHandler(function (error) {
                hideLoading();
                console.error('Error al dar de baja producto(s):', error);
                mostrarMensaje('Error de comunicación al dar de baja producto(s): ' + error.message, 'error');
            })
            .deactivateProducts(idsToDeactivate); 
    }
}


function actualizarControlesPaginacionNotificaciones() {
    const totalPaginas = Math.ceil(pageState.productosViejosGlobal.length / pageState.elementosPorPaginaNotificaciones);
    const infoPaginaEl = document.getElementById("infoPaginaNotificaciones");
    const btnAnteriorEl = document.getElementById("btnAnteriorNotif");
    const btnSiguienteEl = document.getElementById("btnSiguienteNotif");
    if (infoPaginaEl) {
        if (totalPaginas === 0) {
            infoPaginaEl.textContent = "Página 0 de 0";
        } else {
            infoPaginaEl.textContent = `Página ${pageState.paginaActualNotificaciones} de ${totalPaginas}`;
        }
    }
    if (btnAnteriorEl) btnAnteriorEl.disabled = pageState.paginaActualNotificaciones === 1 || totalPaginas === 0;
    if (btnSiguienteEl) btnSiguienteEl.disabled = pageState.paginaActualNotificaciones === totalPaginas || totalPaginas === 0;
}

function paginaSiguienteNotificaciones() {
    const totalPaginas = Math.ceil(pageState.productosViejosGlobal.length / pageState.elementosPorPaginaNotificaciones);
    if (pageState.paginaActualNotificaciones < totalPaginas) {
        pageState.paginaActualNotificaciones++;
        renderizarTablaNotificaciones(); 
    }
}
function paginaAnteriorNotificaciones() {
    if (pageState.paginaActualNotificaciones > 1) {
        pageState.paginaActualNotificaciones--;
        renderizarTablaNotificaciones(); 
    }
}

function clearNotifications() {
    pageState.productosViejosGlobal = []; 
    renderizarTablaNotificaciones(); 
    const notificacionCampanaCount = document.getElementById("notificacionCampanaCount");
    if (notificacionCampanaCount) {
        notificacionCampanaCount.style.display = "none";
        notificacionCampanaCount.textContent = "0";
    }
    mostrarMensaje('Notificaciones limpiadas.', 'success');
}
// ===================================
// --- FUNCIONES DE UTILIDAD ---
// ===================================
function convertDaysToMonths(days) {
    if (typeof days !== 'number' || isNaN(days) || days < 0) {
        return 0;
    }
    return Math.floor(days / 30.44);
}
function formatDate(dateString) {
    if (!dateString) return "";
    let date = new Date(dateString);
    if (isNaN(date.getTime()) && typeof dateString === 'number' && dateString > 25569) {
        date = new Date((dateString - 25569) * 86400000 + new Date().getTimezoneOffset() * 60000);
    }
    if (isNaN(date.getTime())) return "Fecha Inv.";
    let day = date.getDate();
    let month = date.getMonth() + 1;
    let year = date.getFullYear();
    day = day < 10 ? '0' + day : day;
    month = month < 10 ? '0' + month : month;
    return `${day}/${month}/${year}`;
}
// ===============================================
// --- EVENT LISTENERS E INICIALIZACIÓN DE LA PÁGINA ---
// ===============================================
window.onclick = function (event) {
    if (!event.target.matches(".sort-menu-icon") && !event.target.closest(".sort-menu-icon")) {
        const dropdowns = document.getElementsByClassName("sort-options");
        for (let i = 0; i < dropdowns.length; i++) {
            if (dropdowns[i].classList.contains("show")) {
                dropdowns[i].classList.remove("show");
            }
        }
    }
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target == modal) {
            if (modal.id === "modalAgregar") cerrarModalAgregar();
            else if (modal.id === "modalEditar") cerrarModalEditar();
            else if (modal.id === "modalRetiro") cerrarModalRetiro();
            else if (modal.id === "modalComentario") cerrarModalComentario();
            else if (modal.id === "modalNotificaciones") cerrarModalNotificaciones();
            else if (modal.id === "modalVerImagen") cerrarModalVerImagen();
        }
    });
};
function inicializarPaginaArticulos() {
    const setupFilterListener = (id, eventType, handler) => {
        const element = document.getElementById(id);
        if (element) element.addEventListener(eventType, handler);
        else console.warn(`Elemento de filtro no encontrado: ${id}`);
    };
    setupFilterListener("buscarProducto", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroPrograma", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroFechaIngreso", "change", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroUnidades", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroTiempoStorage", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroEstado", "change", aplicarFiltrosYOrdenar);

    const selectAllCheckbox = document.getElementById('selectAllNotifications');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(event) {
            const checkboxes = document.querySelectorAll('#tablaBodyNotificaciones .select-notification-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = event.target.checked;
            });
        });
    }

    const toggleFiltrosBtn = document.getElementById("toggleFiltrosIconContainer");
    const filtrosContainer = document.getElementById("filtrosAdicionalesContainer");
    if (toggleFiltrosBtn && filtrosContainer) {
        filtrosContainer.classList.add("filtros-adicionales-ocultos");
        toggleFiltrosBtn.addEventListener("click", toggleFiltrosAdicionalesArticulos);
    }
    const filtroEstadoSelect = document.getElementById("filtroEstado");
    if (filtroEstadoSelect) {
        filtroEstadoSelect.value = "activo";
    }
    loadInventario();
    cargarNotificacionesNuevas(); // Llama a la nueva función de carga inicial
}

// Exponer funciones al scope global para que los `onclick` funcionen
window.abrirModalAgregar = abrirModalAgregar;
window.cerrarModalAgregar = cerrarModalAgregar;
window.abrirModalRetiro = abrirModalRetiro;
window.cerrarModalRetiro = cerrarModalRetiro;
window.abrirModalEditar = abrirModalEditar;
window.cerrarModalEditar = cerrarModalEditar;
window.abrirModalComentario = abrirModalComentario;
window.cerrarModalComentario = cerrarModalComentario;
window.abrirModalNotificacionesInterno = abrirModalNotificacionesInterno;
window.cerrarModalNotificaciones = cerrarModalNotificaciones;
window.abrirModalVerImagen = abrirModalVerImagen;
window.cerrarModalVerImagen = cerrarModalVerImagen;
window.abrirImagenNuevaVentana = abrirImagenNuevaVentana;
window.confirmarEliminar = confirmarEliminar;
window.limpiarTodosLosFiltrosArticulos = limpiarTodosLosFiltrosArticulos;
window.limpiarTodosLosFiltros = limpiarTodosLosFiltrosArticulos; // Alias for HTML
window.searchItemsArticulos = searchItemsArticulos;
window.searchItems = searchItemsArticulos; // Alias for HTML
window.clearSearchArticulos = clearSearchArticulos;
window.clearSearch = clearSearchArticulos; // Alias for HTML
window.ordenarPorFechaArticulos = ordenarPorFechaArticulos;
window.ordenarPorFecha = ordenarPorFechaArticulos; // Alias for HTML
window.ordenarAscendenteArticulos = ordenarAscendenteArticulos;
window.ordenarAscendente = ordenarAscendenteArticulos; // Alias for HTML
window.ordenarDescendenteArticulos = ordenarDescendenteArticulos;
window.ordenarDescendente = ordenarDescendenteArticulos; // Alias for HTML
window.toggleFiltrosAdicionalesArticulos = toggleFiltrosAdicionalesArticulos;
window.changePage = changePage;
window.handleIndividualCheckboxChange = handleIndividualCheckboxChange;
window.deactivateSelectedNotifications = deactivateSelectedNotifications;
window.paginaSiguienteNotificaciones = paginaSiguienteNotificaciones;
window.paginaAnteriorNotificaciones = paginaAnteriorNotificaciones;
window.clearNotifications = clearNotifications;
window.formatDate = formatDate;

inicializarPaginaArticulos();

})();
</script>