<script>
// ===============================================
// --- VARIABLES GLOBALES PARA LA GESTIÓN DE USUARIOS ---
// ===============================================
let fullUsuarioData = []; // Almacena la lista completa de usuarios cargada desde el servidor.
let currentUsuarioPage = 1; // La página actual de la tabla de usuarios.
let usuarioItemsPerPage = 10; // Número de usuarios a mostrar por página.
let nombreCompletoEditarUsuarioId = null; // Guarda el ID del usuario que se está editando.
let ingresoActualEditarUsuario = 0; // Variable de estado, parece no usarse pero se mantiene por si acaso.
let fechaOrdenAscendenteUsuario = false; // Controla la dirección del ordenamiento por fecha.


// ===================================
// --- MANEJO DE MODALES DE USUARIO ---
// ===================================

/**
 * @summary Abre el modal para agregar un nuevo usuario.
 * @description Muestra el modal y resetea el formulario para una nueva entrada.
 */
function abrirModalAgregarUsuario() {
  document.getElementById('modalAgregarUsuario').style.display = 'block';
  document.getElementById('agregarUsuarioForm').reset();
}

function cerrarModalAgregarUsuario() {
  document.getElementById('modalAgregarUsuario').style.display = 'none';
}
/**
 * @summary Abre el modal para editar un usuario existente.
 * @description Busca el usuario por su ID y rellena el formulario de edición con sus datos actuales.
 * @param {string|number} id - El ID del usuario a editar.
 */
function abrirModalEditarUsuario(id) {
  nombreCompletoEditarUsuarioId = id;
  const usuario = fullUsuarioData.find(item => item.Id == id);
  if (usuario) {
    document.getElementById('modalEditarUsuario').style.display = 'block';
    document.getElementById('usuarioIdEditarUsuario').textContent = id;
    document.getElementById('nombreCompletoEditarUsuario').value = usuario['NombreCompleto'];
    document.getElementById('userNameEditarUsuario').value = usuario['userName'];
    document.getElementById('passwordEditarUsuario').value = usuario['password'];
    document.getElementById('cdeEditarUsuario').value = usuario['CDE'];
    document.getElementById('emailEditarUsuario').value = usuario['Email'];
    document.getElementById('rolEditarUsuario').value = usuario['Rol'];
  } else {
    console.error('No se encontró el usuario con ID:', id);
  }
}

function cerrarModalEditarUsuario() {
  document.getElementById('modalEditarUsuario').style.display = 'none';
  document.getElementById('editarUsuarioForm').reset();
  nombreCompletoEditarUsuarioId = null;
  ingresoActualEditarUsuario = 0;
}

// ===================================
// --- FUNCIONES DE FEEDBACK DE UI ---
// ===================================

/**
 * @summary Muestra un mensaje de feedback en la página de gestión de usuarios.
 * @param {string} mensaje - El texto a mostrar.
 */
function mostrarMensajeUsuario(mensaje) {
  const mensajeDiv = document.getElementById('mensajeConfirmacionUsuario');
  mensajeDiv.querySelector('span').textContent = mensaje;
  mensajeDiv.style.display = 'block';
}

function cerrarMensajeUsuario() {
  document.getElementById('mensajeConfirmacionUsuario').style.display = 'none';
}

/**
 * @summary Muestra la superposición de carga y deshabilita los botones de los formularios.
 */
function showLoadingUsuario() {
  document.getElementById('loadingOverlayUsuario').style.display = 'block';
  disableFormButtonsUsuario();
}
/**
 * @summary Oculta la superposición de carga y habilita los botones de los formularios.
 */
function hideLoadingUsuario() {
  document.getElementById('loadingOverlayUsuario').style.display = 'none';
  enableFormButtonsUsuario();
}
/**
 * @summary Deshabilita los botones de envío de los formularios para evitar acciones duplicadas.
 */
function disableFormButtonsUsuario() {
  const buttons = document.querySelectorAll('form .submit-btn');
  buttons.forEach(button => {
    button.disabled = true;
  });
}
/**
 * @summary Habilita los botones de envío de los formularios.
 */
function enableFormButtonsUsuario() {
  const buttons = document.querySelectorAll('form .submit-btn');
  buttons.forEach(button => {
    button.disabled = false;
  });
}

// =============================================
// --- MANEJADORES DE ENVÍO DE FORMULARIOS Y ACCIONES ---
// =============================================

// Maneja el envío del formulario para agregar un nuevo usuario.
document.getElementById('agregarUsuarioForm')  .addEventListener('submit', function (e) {
    e.preventDefault();
    showLoadingUsuario();
    const data = {
      nombreCompletoAgregar: document.getElementById('nombreCompletoAgregarUsuario').value.trim(),
      userNameAgregar: document.getElementById('userNameAgregarUsuario').value.trim(),
      passwordAgregar: document.getElementById('passwordAgregarUsuario').value.trim(),
      cdeAgregar: document.getElementById('cdeAgregarUsuario').value.trim(),
      emailAgregar: document.getElementById('emailAgregarUsuario').value.trim(),
      rolAgregar: document.getElementById('rolAgregarUsuario').value.trim(),
      fechaRegistro: new Date().toISOString(),
    };

    google.script.run
      .withSuccessHandler(function (mensaje) {
        hideLoadingUsuario();
        loadUsuario();
        cerrarModalAgregarUsuario();
        mostrarMensajeUsuario(mensaje);
      })
      .withFailureHandler(function (error) {
        hideLoadingUsuario();
        console.error('Error adding user:', error);
        mostrarMensajeUsuario('Error al agregar usuario.');
      })
      .agregarUsuario(data, 'Usuario');
  });
// Maneja el envío del formulario para editar un usuario existente.
document.getElementById('editarUsuarioForm').addEventListener('submit', function (e) {
    e.preventDefault();
    showLoadingUsuario();
    const data = {
      idEditar: nombreCompletoEditarUsuarioId,
      nombreCompletoEditar: document.getElementById('nombreCompletoEditarUsuario').value,
      userNameEditar: document.getElementById('userNameEditarUsuario').value,
      passwordEditar: document.getElementById('passwordEditarUsuario').value,
      
    };
    console.log('Datos a enviar para editar:', data); // Agrege esta línea para depurar
    google.script.run
      .withSuccessHandler(function (response) {
        hideLoadingUsuario();
        loadUsuario();
        cerrarModalEditarUsuario();
      try {
      const responseObject = JSON.parse(response);
      mostrarMensajeUsuario(responseObject.message); // Extraer el mensaje
    } catch (e) {
      mostrarMensajeUsuario(response); // Si no es JSON, mostrar como antes
    }
  })
      .actualizarUsuario(data, 'Usuario');
  });
/**
 * @summary Pide confirmación al usuario y, si se acepta, llama a la función del servidor para desactivar un usuario.
 * @param {string|number} id - El ID del usuario a desactivar.
 */
function confirmarEliminarUsuario(id) {
  if (confirm('¿Seguro que deseas desactivar este usuario?')) {
    showLoadingUsuario();
    google.script.run
      .withSuccessHandler(function (mensaje) {
        hideLoadingUsuario();
        loadUsuario();
        mostrarMensajeUsuario(mensaje);
      })
      .withFailureHandler(function (error) {
        hideLoadingUsuario();
        console.error('Error deleting user:', error);
        mostrarMensajeUsuario('Error al desactivar usuario.');
      })
      .eliminarUsuario(id, 'Usuario'); // Llamada a la función genérica
  }
}
// ===================================
// --- CARGA, RENDERIZADO Y PAGINACIÓN 
// ===================================

/**
 * @summary Carga la lista completa de usuarios desde el servidor.
 */
function loadUsuario() {
  console.log('Iniciando loadUsuario');
  google.script.run
    .withSuccessHandler(function (json) {
      try {
        const response = JSON.parse(json);
        if (response && response.data) {
          fullUsuarioData = response.data;
          fullUsuarioData.sort((a, b) => {
            const fechaA = new Date(a['Fecha de Registro']);
            const fechaB = new Date(b['Fecha de Registro']);
            return fechaB - fechaA;
          });
          renderUsuarioPaginatedTable(fullUsuarioData);
        } else {
          console.error('Error loading users: invalid response');
          document.getElementById('tablaUsuarioBody').innerHTML ="<tr><td colspan='9'>Error al cargar los usuarios.</td></tr>";
        }
      } catch (e) {
        console.error('Error parsing user response:', e);
        document.getElementById('tablaUsuarioBody').innerHTML ="<tr><td colspan='9'>Error al procesar los datos de los usuarios.</td></tr>";
      }
    })
    .withFailureHandler(function (error) {
      console.error('Error getting user data:', error);
      mostrarMensajeUsuario('Error al cargar los usuarios.');
    })
    .getInventoryDataForSheet('Usuario'); // Llamada a la función genérica
  console.log('Finalizando loadUsuario');
}
/**
 * @summary Renderiza una página específica de la tabla de usuarios.
 * @param {Array<object>} data - El conjunto de datos (completo o filtrado) a paginar.
 */
function renderUsuarioPaginatedTable(data) {
  const start = (currentUsuarioPage - 1) * usuarioItemsPerPage;
  const paginatedItems = data.slice(start, start + usuarioItemsPerPage);
  generateUsuarioTable(paginatedItems);
  renderUsuarioPaginationControls(data.length);
}
/**
 * @summary Construye y muestra las filas de la tabla de usuarios en el DOM.
 * @param {Array<object>} items - Un arreglo de objetos de usuario para mostrar.
 */
function generateUsuarioTable(items) {
  const tbody = document.getElementById('tablaUsuarioBody');
  tbody.innerHTML = '';

  if (items.length === 0) {
    tbody.innerHTML =
      "<tr><td colspan='10'>No hay usuarios registrados.</td></tr>";
    return;
  }

  items.forEach(item => {
    const row = document.createElement('tr');

    row.innerHTML = `
      <td>${item['Id']}</td>
      <td>${item['NombreCompleto']}</td>
      <td>${item['userName']}</td>
      <td>${item['password']}</td>
      <td>${item['CDE']}</td>
      <td>${item['Email']}</td>
      <td>${item['Estado_User']}</td>
      <td>${item['Rol']}</td>
      <td>${formatDate(item['Fecha de Registro'])}</td>
     
      <td>
        <button class="btn-modificar" onclick="abrirModalEditarUsuario('${item['Id']}')">
          <ion-icon name="reader-outline" class="btn-icon"></ion-icon> 
        </button>
        <button class="btn-eliminar" onclick="confirmarEliminarUsuario('${item['Id']}')">
          <ion-icon name="trash-outline" class="btn-icon"></ion-icon> 
        </button>
      </td>
    `;
    tbody.appendChild(row);
  });
}
/**
 * @summary Genera y muestra los controles de paginación para la tabla de usuarios.
 * @param {number} totalItems - El número total de ítems a paginar.
 */
function renderUsuarioPaginationControls(totalItems) {
  const totalPages = Math.ceil(totalItems / usuarioItemsPerPage);
  let controlsHTML = '';
  let maxButtons = 5;
  controlsHTML += `<button onclick="changeUsuarioPage(${currentUsuarioPage - 1  })" ${currentUsuarioPage === 1 ? 'disabled' : ''}>Anterior</button>`;
  let startPage = 1;
  let endPage = totalPages;
  if (totalPages > maxButtons) {
    const halfButtons = Math.floor(maxButtons / 2);
    if (currentUsuarioPage <= halfButtons) {
      endPage = maxButtons;
    } else if (currentUsuarioPage >= totalPages - halfButtons) {
      startPage = totalPages - maxButtons + 1;
    } else {
      startPage = currentUsuarioPage - halfButtons;
      endPage = currentUsuarioPage + halfButtons;
    }
  }

  if (startPage > 1) {
    controlsHTML += `<span class="pagination-dots">...</span>`;
  }

  for (let i = startPage; i <= endPage; i++) {
    const activeClass = i === currentUsuarioPage ? 'active' : '';
    controlsHTML += `<button class="${activeClass}" onclick="changeUsuarioPage(${i})">${i}</button>`;
  }

  if (endPage < totalPages) {
    controlsHTML += `<span class="pagination-dots">...</span>`;
  }

  controlsHTML += `<button onclick="changeUsuarioPage(${
    currentUsuarioPage + 1
  })" ${
    currentUsuarioPage === totalPages ? 'disabled' : ''
  }>Siguiente</button>`;

  document.getElementById('usuarioPagination').innerHTML = controlsHTML;
  updateActiveUsuarioPage();
}
/**
 * @summary Cambia la página actual de la tabla de usuarios y la vuelve a renderizar.
 * @param {number} page - El número de página al que se quiere ir.
 */
function changeUsuarioPage(page) {
  currentUsuarioPage = page;
  renderUsuarioPaginatedTable(fullUsuarioData);
  updateActiveUsuarioPage();
}
/**
 * @summary Actualiza el estilo del botón de la página activa en la paginación.
 */
function updateActiveUsuarioPage() {
  const buttons = document.querySelectorAll('#UsuarioPagination button');
  buttons.forEach(button => button.classList.remove('active'));
  const activeButton = document.querySelector(
    `#UsuarioPagination button:nth-child(${
      currentUsuarioPage + (currentUsuarioPage > 5 ? 2 : 1)
    })`
  );
  if (activeButton) {
    activeButton.classList.add('active');
  }
}


// ===================================
// --- ORDENAMIENTO Y BÚSQUEDA ---
// ===================================

/**
 * @summary Filtra la lista de usuarios por nombre completo.
 */
function buscarPorNombreUsuario() {
  const query = document.getElementById('buscarUsuario').value.toLowerCase();
  const resultado = fullUsuarioData.filter(
    item =>
      item['NombreCompleto'] &&
      item['NombreCompleto'].toLowerCase().includes(query)
  );
  currentUsuarioPage = 1;
  renderUsuarioPaginatedTable(resultado);
}
/**
 * @summary Muestra/oculta el menú de opciones para ordenar por fecha.
 * @param {Event} event - El evento de clic.
 */
function ordenarPorFechaUsuario(event) {
  event.stopPropagation();
  document.getElementById('sortOptions').classList.toggle('show');
}
/**
 * @summary Ordena los usuarios por fecha de registro ascendente.
 */
function ordenarAscendenteUsuario() {
  fullUsuarioData.sort((a, b) => {
    const fechaA = new Date(a['Fecha de Registro']);
    const fechaB = new Date(b['Fecha de Registro']);
    return fechaA.getTime() - fechaB.getTime();
  });
  fechaOrdenAscendenteUsuario = true;
  renderUsuarioPaginatedTable(fullUsuarioData);
  updateActiveUsuarioPage();
  document.getElementById('sortOptions').classList.remove('show');
}
/**
 * @summary Ordena los usuarios por fecha de registro descendente.
 */
function ordenarDescendenteUsuario() {
  fullUsuarioData.sort((a, b) => {
    const fechaA = new Date(a['Fecha de Registro']);
    const fechaB = new Date(b['Fecha de Registro']);
    return fechaB.getTime() - fechaA.getTime();
  });
  fechaOrdenAscendenteUsuario = false;
  renderUsuarioPaginatedTable(fullUsuarioData);
  updateActiveUsuarioPage();
  document.getElementById('sortOptions').classList.remove('show');
}
// ===================================
// --- UTILIDAD Y EVENTOS GLOBALES ---
// ===================================

/**
 * @summary Formatea una cadena de fecha a un formato 'dd/mm/yyyy'.
 * @param {string} dateString - La fecha a formatear.
 * @returns {string} La fecha formateada.
 */
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return isNaN(date) ? '' : date.toLocaleDateString('es-CO');
}
// Cierra el menú de ordenamiento si se hace clic fuera.
window.onclick = function (event) {
  if (!event.target.matches('.sort-menu-icon')) {
    const dropdowns = document.getElementsByClassName('sort-options');
    for (let i = 0; i < dropdowns.length; i++) {
      const openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
};

// Carga inicial de los datos de usuario cuando la ventana ha cargado.
window.onload = loadUsuario;

  </script>