<script>
(function () {
  console.log('[JS DIAG] Script de Usuario iniciado. El navegador está leyendo este bloque.');

  // Js_Usuario - Versión corregida y consolidada
  // Carga datos desde `getUsuarios()` y provee CRUD/UI para usuarios.

  const state = {
    fullData: [],
    filtered: [],
    currentPage: 1,
    perPage: 10,
    editingId: null,
  };

  console.log('[JS CHECK] Js_Usuario consolidado cargado');

  // Helpers
  function q(id) { return document.getElementById(id); }
  function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function showLoadingLocal(){ if(typeof showLoading==='function') showLoading(true); else { const el=q('loadingOverlay'); if(el) el.style.display='flex'; }}
  function hideLoadingLocal(){ if(typeof hideLoading==='function') hideLoading(); else { const el=q('loadingOverlay'); if(el) el.style.display='none'; }}
  function showMsg(msg, type='success'){ if(typeof mostrarMensaje === 'function') mostrarMensaje(msg, type); else alert(msg); }

  // Render tabla y paginación
  function renderTable(){
    const tbody = q('tablaUsuarioBody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const start = (state.currentPage-1)*state.perPage;
    const pageItems = state.filtered.slice(start, start+state.perPage);

    if(pageItems.length === 0){
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No hay usuarios para mostrar.</td></tr>';
      renderPagination();
      return;
    }

    pageItems.forEach(u => {
      const id = u['Id'] || u['ID'] || u.id || '';
      const nombre = u['Nombre Completo'] || u['NombreCompleto'] || u.nombre || '';
      const user = u['Usuario'] || u.userName || u.user || '';
      const cde = u['CDE'] || u.cde || '';
      const email = u['Email'] || u.email || '';
      const estado = u['Estado Usuario'] || u['Estado_User'] || u.Estado || '';
      const rol = u['Rol'] || u.rol || '';
      const fecha = u['Fecha Registro'] || u['Fecha de Registro'] || u['FECHA DE INGRESO'] || u['FechaRegistro'] || '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(id)}</td>
        <td>${escapeHtml(nombre)}</td>
        <td>${escapeHtml(user)}</td>
        <td>******</td>
  
        <td>${escapeHtml(cde)}</td>
        <td>${escapeHtml(email)}</td>
        <td>${escapeHtml(estado)}</td>
        <td>${escapeHtml(rol)}</td>
        <td>${escapeHtml(fecha)}</td>
        <td>
          <button class="btn-edit" data-id="${escapeHtml(id)}">Editar</button>
          <button class="btn-delete" data-id="${escapeHtml(id)}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    renderPagination();
  }

  function renderPagination(){
    const total = state.filtered.length;
    const pages = Math.max(1, Math.ceil(total/state.perPage));
    const container = q('usuarioPagination');
    if(!container) return;
    container.innerHTML = '';

    for(let i=1;i<=pages;i++){
      const btn = document.createElement('button');
      btn.textContent = i;
      if(i===state.currentPage) btn.classList.add('active');
      btn.addEventListener('click', ()=>{ state.currentPage = i; renderTable(); });
      container.appendChild(btn);
    }
  }

  // Normalizar respuesta del servidor
  function normalizeServerResponse(resp){
    if(!resp) return [];
    if(Array.isArray(resp)) return resp;
    if(typeof resp === 'string'){
      try{ const p = JSON.parse(resp); return normalizeServerResponse(p); }catch(e){ return []; }
    }
    if(resp.data && Array.isArray(resp.data)) return resp.data;
    return [];
  }

  // Cargar usuarios
  function loadUsers(){
    showLoadingLocal();
    console.log('[JS USR] solicitando getUsuarios()...');

    // --- INICIO: Fallback por Timeout ---
    const timeoutId = setTimeout(() => {
      console.error('[JS USR] Timeout: La llamada a getUsuarios() tardó demasiado.');
      hideLoadingLocal();
      showMsg('El servidor tardó demasiado en responder. Revisa la conexión y los logs del servidor.', 'error');
    }, 10000); // 15 segundos de espera
    // --- FIN: Fallback por Timeout ---

    if(typeof google === 'undefined' || !google.script || !google.script.run){
      console.error('[JS USR] google.script.run no disponible');
      hideLoadingLocal();
      showMsg('google.script.run no está disponible. Ejecuta la WebApp correctamente.', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler((resp)=>{
        clearTimeout(timeoutId); // <-- Cancelar el timeout si hay éxito
        console.log('[JS USR] getUsuarios success', resp);
        const data = normalizeServerResponse(resp);
        state.fullData = data;
        state.filtered = [...state.fullData];
        state.currentPage = 1;
        hideLoadingLocal();
        renderTable();
      })
      .withFailureHandler((err)=>{
        clearTimeout(timeoutId); // <-- Cancelar el timeout si hay fallo
        console.error('[JS USR] getUsuarios failure', err);
        hideLoadingLocal();
        showMsg('Error al cargar usuarios: ' + (err && err.message ? err.message : err), 'error');
      })
      .getUsuarios();
  }

  // Búsqueda
  function applySearch(){
    const term = (q('buscarUsuario')?.value || '').toLowerCase().trim();
    if(!term){ state.filtered = [...state.fullData]; state.currentPage = 1; renderTable(); return; }
    state.filtered = state.fullData.filter(u => {
      const nombre = (u['Nombre Completo']||u['NombreCompleto']||u.nombre||'').toString().toLowerCase();
      const user = (u['Usuario']||u.userName||u.user||'').toString().toLowerCase();
      return nombre.includes(term) || user.includes(term);
    });
    state.currentPage = 1;
    renderTable();
  }

  // CRUD: agregar
  function submitAdd(e){
    e.preventDefault();
    const payload = {
      nombreCompleto: q('nombreCompletoAgregarUsuario').value,
      userName: q('userNameAgregarUsuario').value,
      password: q('passwordAgregarUsuario').value,
      cde: q('cdeAgregarUsuario').value,
      email: q('emailAgregarUsuario').value,
      rol: q('rolAgregarUsuario').value,
      estado: q('estadoAgregarUsuario').value,
    };
    showLoadingLocal();
    google.script.run
      .withSuccessHandler((r)=>{ hideLoadingLocal(); showMsg('Usuario agregado', 'success'); cerrarModal('modalAgregarUsuario'); loadUsers(); })
      .withFailureHandler((err)=>{ hideLoadingLocal(); showMsg('Error al agregar: ' + (err && err.message ? err.message : err), 'error'); })
      .agregarUsuario(payload);
  }

  // CRUD: editar
  function openEditModal(id){
    const usuario = state.fullData.find(u => String(u.Id||u.id||u.ID) === String(id));
    if(!usuario){ showMsg('Usuario no encontrado', 'error'); return; }
    state.editingId = id;
    abrirModal('modalEditarUsuario');
    q('usuarioIdEditarUsuario').textContent = id;
    q('nombreCompletoEditarUsuario').value = usuario['Nombre Completo']||usuario['NombreCompleto']||usuario.nombre||'';
    q('userNameEditarUsuario').value = usuario['Usuario']||usuario.userName||usuario.user||'';
    q('passwordEditarUsuario').value = '';
    q('cdeEditarUsuario').value = usuario['CDE']||usuario.cde||'';
    q('emailEditarUsuario').value = usuario['Email']||usuario.email||'';
    q('rolEditarUsuario').value = usuario['Rol']||usuario.rol||'Usuario';
    q('estadoEditarUsuario').value = usuario['Estado Usuario']||usuario['Estado_User']||usuario.Estado||'Activo';
  }

  function submitEdit(e){
    e.preventDefault();
    const payload = {
      id: state.editingId,
      nombreCompleto: q('nombreCompletoEditarUsuario').value,
      userName: q('userNameEditarUsuario').value,
      password: q('passwordEditarUsuario').value,
      cde: q('cdeEditarUsuario').value,
      email: q('emailEditarUsuario').value,
      rol: q('rolEditarUsuario').value,
      estado: q('estadoEditarUsuario').value,
    };
    showLoadingLocal();
    google.script.run
      .withSuccessHandler((r)=>{ hideLoadingLocal(); showMsg('Usuario actualizado', 'success'); cerrarModal('modalEditarUsuario'); loadUsers(); })
      .withFailureHandler((err)=>{ hideLoadingLocal(); showMsg('Error al editar: ' + (err && err.message ? err.message : err), 'error'); })
      .editarUsuario(payload);
  }

  // CRUD: eliminar
  function deleteUser(id){
    if(!confirm('¿Seguro que desea desactivar este usuario?')) return;
    showLoadingLocal();
    google.script.run
      .withSuccessHandler((r)=>{ hideLoadingLocal(); showMsg('Usuario desactivado', 'success'); loadUsers(); })
      .withFailureHandler((err)=>{ hideLoadingLocal(); showMsg('Error al eliminar: ' + (err && err.message ? err.message : err), 'error'); })
      .eliminarUsuario(id);
  }

  // Delegación de eventos en la tabla
  function attachTableDelegation(){
    const tbody = q('tablaUsuarioBody');
    if(!tbody) return;
    tbody.addEventListener('click', function(e){
      const btnEdit = e.target.closest('.btn-edit');
      const btnDel = e.target.closest('.btn-delete');
      if(btnEdit){ openEditModal(btnEdit.dataset.id); }
      if(btnDel){ deleteUser(btnDel.dataset.id); }
    });
  }

  // Inicialización
  function initHandlers(){
    console.log('[JS DIAG] initHandlers: Adjuntando eventos...');
    q('buscarUsuario')?.addEventListener('input', applySearch);
    q('sortContainer')?.addEventListener('click', (e)=>{ e.stopPropagation(); q('sortOptions').classList.toggle('show'); });
    q('agregarUsuarioForm')?.addEventListener('submit', submitAdd);
    q('editarUsuarioForm')?.addEventListener('submit', submitEdit);
    q('toggleSidebarBtn')?.addEventListener('click', ()=>{ document.body.classList.toggle('sidebar-collapsed'); });
    attachTableDelegation();
    console.log('[JS DIAG] initHandlers: Eventos adjuntados.');
  }

  function initializeApp() {
    console.log('[JS DIAG] initializeApp: El DOM está listo. Iniciando la aplicación de usuario.');
    initHandlers();
    console.log('[JS DIAG] initializeApp: Llamando a loadUsers().');
    loadUsers();
    console.log('[JS DIAG] initializeApp: La llamada a loadUsers() ha sido despachada.');
  }

  // Robusto DOMContentLoaded handler
  if (document.readyState === 'loading') {
    // El DOM todavía está cargando, esperar al evento
    document.addEventListener('DOMContentLoaded', initializeApp);
    console.log('[JS DIAG] Registrado listener para DOMContentLoaded.');
  } else {
    // El DOM ya está listo, ejecutar inmediatamente
    console.log('[JS DIAG] El DOM ya está listo (readyState: ' + document.readyState + '). Ejecutando initializeApp() directamente.');
    initializeApp();
  }

  console.log('[JS DIAG] Script de Usuario: Fin del bloque de script alcanzado.');

})();
</script>
