<!-- Js_Dashboard.html -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
/* =========================
   Variables globales
   ========================= */
let cacheData = null; // aqu칤 guardamos los datos que llegan del servidor
let graficoGastoComida = null;
let graficoGastoDecoracion = null;

/* =========================
   Helpers
   ========================= */
function showLoading() {
  const o = document.getElementById('loading-overlay');
  if (o) o.style.display = 'flex';
}
function hideLoading() {
  const o = document.getElementById('loading-overlay');
  if (o) o.style.display = 'none';
}

function setTextById(id, value) {
  const el = document.getElementById(id);
  if (el) el.textContent = value != null ? value : '';
}

function formatNumber(n) {
  try { return Number(n).toLocaleString(); } catch(e){ return String(n); }
}

function destroyChartIfExists(canvasId) {
  const chart = Chart.getChart(canvasId);
  if (chart) chart.destroy();
}

/* =========================
   Render de gr치ficos
   ========================= */
function renderPieChart(canvasId, labels, data, title) {
  destroyChartIfExists(canvasId);
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets: [{ data, backgroundColor: ['#4a90e2','#e94e77','#2ecc71','#f39c12','#9b59b6'] }] },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right' },
        title: { display: !!title, text: title }
      }
    }
  });
}

function renderBarChart(canvasId, labels, data, title) {
  destroyChartIfExists(canvasId);
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: title, data, backgroundColor: '#4a90e2' }] },
    options: {
      responsive: true,
      plugins: { title: { display: !!title, text: title } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function renderLineChart(canvasId, labels, data, title) {
  destroyChartIfExists(canvasId);
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: title, data, fill: true, borderColor: '#4a90e2', tension: 0.2 }] },
    options: {
      responsive: true,
      plugins: { title: { display: !!title, text: title } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

/* =========================
   Filtros con listener 칰nico
   ========================= */
function llenarFiltroAno(selectId, datos, callback) {
  const filtro = document.getElementById(selectId);
  if (!filtro) return;
  filtro.innerHTML = '<option value="">Todos los a침os</option>';
  const anos = [...new Set(Object.keys(datos || {}).map(k => k.split('-')[0]))].sort();
  anos.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a; opt.textContent = a;
    filtro.appendChild(opt);
  });
  filtro.onchange = callback;
}

/* =========================
   Gr치fico de gastos con resalte
   ========================= */
function actualizarGraficoGasto(canvasId, datos, filtroId, titulo) {
  const anoSel = document.getElementById(filtroId)?.value || '';
  const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  const valores = [];
  const etiquetas = [];

  for (let i=1;i<=12;i++) {
    const mm = i.toString().padStart(2,'0');
    let val = 0;
    if (!anoSel) {
      for (const k of Object.keys(datos||{})) {
        if (k.endsWith('-'+mm)) val += datos[k];
      }
    } else {
      val = datos[`${anoSel}-${mm}`] || 0;
    }
    if (anoSel || val > 0) {
      etiquetas.push(meses[i-1]);
      valores.push(val);
    }
  }

  // resaltar mayor
  const maxVal = Math.max(...valores,0);
  const bgColors = valores.map(v => v===maxVal ? '#e94e77' : '#4a90e2');

  destroyChartIfExists(canvasId);
  const ctx = document.getElementById(canvasId)?.getContext('2d');
  if (!ctx) return;
  if (canvasId==='gastoComidaPorMes') { if (graficoGastoComida) graficoGastoComida.destroy(); }
  if (canvasId==='gastoDecoracionPorMes') { if (graficoGastoDecoracion) graficoGastoDecoracion.destroy(); }

  const chart = new Chart(ctx, {
    type: 'bar',
    data: { labels: etiquetas, datasets: [{ label: titulo, data: valores, backgroundColor: bgColors }] },
    options: {
      responsive: true,
      plugins: { title: { display: true, text: titulo } },
      scales: { y: { beginAtZero: true } }
    }
  });

  if (canvasId==='gastoComidaPorMes') graficoGastoComida = chart;
  if (canvasId==='gastoDecoracionPorMes') graficoGastoDecoracion = chart;
}

/* =========================
   Funci칩n principal
   ========================= */
function updateDashboard(data) {
  hideLoading();
  if (!data) return;
  cacheData = data; // 游댐 guardar datos en memoria

  // KPIs globales
  setTextById('total-gastos', formatNumber(data.resumen?.totalGastos || 0));
  setTextById('categoria-mayor-gasto', data.resumen?.categoriaMayorGasto?.categoria || 'N/A');

  // tendencia global
  const tendencia = data.resumen?.tendenciaGlobal || {};
  const keys = Object.keys(tendencia).sort();
  renderLineChart('tendencia-global-chart', keys, keys.map(k=>tendencia[k]), 'Tendencia Global');

  // Inventario
  const inv = data.inventario || {};
  setTextById('inv-total-productos', inv.totalProductos || 0);
  setTextById('inv-unidades-disponibles', inv.unidadesDisponibles || 0);
  setTextById('inv-unidades-agotadas', inv.unidadesAgotadas || 0);
  setTextById('inv-total-programas', Object.keys(inv.programas||{}).length);
  setTextById('inv-stock-mas-8meses', inv.masDeOchoMeses || 0);
  renderPieChart('inv-pie-chart', Object.keys(inv.programas||{}), Object.values(inv.programas||{}), 'Inventario');

  // Comida
  const com = data.comida || {};
  setTextById('com-total-productos', com.totalProductos || 0);
  setTextById('com-unidades-disponibles', com.unidadesDisponibles || 0);
  setTextById('com-unidades-agotadas', com.unidadesAgotadas || 0);
  llenarFiltroAno('filtroAnoComida', com.gastoMensual, () => {
    actualizarGraficoGasto('gastoComidaPorMes', com.gastoMensual, 'filtroAnoComida', 'Gasto Comida');
  });
  actualizarGraficoGasto('gastoComidaPorMes', com.gastoMensual, 'filtroAnoComida', 'Gasto Comida');

  // Decoraci칩n
  const dec = data.decoracion || {};
  setTextById('dec-total-productos', dec.totalProductos || 0);
  setTextById('dec-unidades-disponibles', dec.unidadesDisponibles || 0);
  setTextById('dec-unidades-agotadas', dec.unidadesAgotadas || 0);
  llenarFiltroAno('filtroAnoDecoracion', dec.gastoMensual, () => {
    actualizarGraficoGasto('gastoDecoracionPorMes', dec.gastoMensual, 'filtroAnoDecoracion', 'Gasto Decoraci칩n');
  });
  actualizarGraficoGasto('gastoDecoracionPorMes', dec.gastoMensual, 'filtroAnoDecoracion', 'Gasto Decoraci칩n');

  // Papeler칤a
  const pap = data.papeleria || {};
  setTextById('pap-total-productos', pap.totalProductos || 0);
  setTextById('pap-unidades-disponibles', pap.unidadesDisponibles || 0);
  setTextById('pap-unidades-agotadas', pap.unidadesAgotadas || 0);
  renderBarChart('pap-bar-chart', (pap.productos||[]).slice(0,7).map(p=>p.producto), (pap.productos||[]).slice(0,7).map(p=>p.unidades), 'Top Papeler칤a');
}

/* =========================
   Inicializaci칩n
   ========================= */
document.addEventListener('DOMContentLoaded', () => {
  showLoading();
  google.script.run.withSuccessHandler(updateDashboard).withFailureHandler(err => {
    hideLoading();
    console.error('Error al cargar datos', err);
  }).obtenerDatosDashboard();
});
</script>
