<script>
/* ============================================
   DASHBOARD DE INVENTARIO - VERSIÓN MEJORADA (SIMPLIFICADA PARA DEPURACIÓN)
   ============================================ */

// Variables globales
let chartInstances = {};
let timeoutId = null;
let dataReceived = false;

/* ============================================
   UTILIDADES
   ============================================ */

function showLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = 'flex';
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = 'none';
  dataReceived = true;
}

/* ============================================
   FUNCIÓN DE ACTUALIZACIÓN SIMPLIFICADA
   ============================================ */

function updateDashboard(data) {
  console.log('1. updateDashboard SE HA EJECUTADO.');
  console.log('Datos recibidos (no se procesarán):', JSON.stringify(data, null, 2));
  
  console.log('2. Llamando a hideLoading().');
  hideLoading();
  console.log('3. hideLoading() llamado. La pantalla de carga debería desaparecer ahora.');

  // Limpiar el contenido del dashboard para evitar errores con elementos que no se renderizarán
  const container = document.querySelector('.dashboard-container');
  if (container) {
    container.innerHTML = '<h1>Prueba de carga completada</h1><p>El dashboard ha sido deshabilitado temporalmente para depuración. Si ves este mensaje, la comunicación con el servidor funciona.</p>';
  }

  alert('¡Prueba completada! La función de carga se ejecutó. Si la pantalla de carga desapareció, el problema está en el renderizado de los gráficos.');
}


/* ============================================
   INICIALIZACIÓN
   ============================================ */

document.addEventListener('DOMContentLoaded', function() {
  console.log('Iniciando carga del dashboard (versión de depuración)...');
  
  showLoading();
  dataReceived = false;

  // Timeout de seguridad
  timeoutId = setTimeout(() => {
    if (!dataReceived) {
      console.warn('Timeout: Los datos no se recibieron en 20 segundos');
      hideLoading();
      alert('La carga del dashboard está tardando más de lo esperado. Por favor, recargue la página.');
    }
  }, 20000);

  // Llamada al servidor
  try {
    google.script.run
      .withSuccessHandler(function(data) {
        if (timeoutId) clearTimeout(timeoutId);
        updateDashboard(data);
      })
      .withFailureHandler(function(error) {
        if (timeoutId) clearTimeout(timeoutId);
        console.error('Error en withFailureHandler:', error);
        hideLoading();
        alert('Error en la llamada al servidor: ' + JSON.stringify(error));
      })
      .obtenerDatosDashboard();
  } catch (error) {
    console.error('Error al iniciar la llamada al servidor:', error);
    hideLoading();
    alert('Error al conectar con el servidor. Por favor, recargue la página.');
  }
});

// Limpieza al cerrar/salir de la página
window.addEventListener('beforeunload', function() {
  if (timeoutId) clearTimeout(timeoutId);
});
</script>