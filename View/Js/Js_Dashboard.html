
<script>
(() => {
  console.log("üìä Iniciando carga del dashboard...");

  google.script.run
    .withSuccessHandler(updateDashboard)
    .withFailureHandler((err) => {
      console.error("‚ùå Error al obtener datos:", err);
      alert("Error al cargar datos del dashboard");
    })
    .obtenerDatosDashboard();

  function updateDashboard(data) {
    console.log("‚úÖ Datos recibidos:", data);
    if (data.error) return showError(data.error);

    // --- INVENTARIO ---
    const inv = data.inventario;
    document.getElementById("total-productos-inventario").textContent = inv.totalProductos;
    document.getElementById("unidades-disponibles-inventario").textContent = inv.unidadesDisponibles;
    document.getElementById("unidades-agotadas-inventario").textContent = inv.unidadesAgotadas;
    document.getElementById("mas-ocho-meses").textContent = inv.masDeOchoMeses;
    createBarChart("chartInventario", Object.keys(inv.programas), Object.values(inv.programas), "Productos por Programa");

    // --- COMIDA ---
    const com = data.comida;
    document.getElementById("total-productos-comida").textContent = com.totalProductos;
    document.getElementById("unidades-disponibles-comida").textContent = com.unidadesDisponibles;
    document.getElementById("unidades-agotadas-comida").textContent = com.unidadesAgotadas;
    createLineChart("chartGastoComida", Object.keys(com.gastoMensual), Object.values(com.gastoMensual), "Gasto Mensual en Comida ($)");

    // --- DECORACI√ìN ---
    const dec = data.decoracion;
    document.getElementById("total-productos-decoracion").textContent = dec.totalProductos;
    document.getElementById("unidades-disponibles-decoracion").textContent = dec.unidadesDisponibles;
    document.getElementById("unidades-agotadas-decoracion").textContent = dec.unidadesAgotadas;
    createBarChart("chartCategoriasDecoracion", Object.keys(dec.categorias), Object.values(dec.categorias), "Unidades por Categor√≠a");
    createLineChart("chartGastoDecoracion", Object.keys(dec.gastoMensual), Object.values(dec.gastoMensual), "Gasto Mensual Decoraci√≥n ($)");

    // --- PAPELER√çA ---
    const pap = data.papeleria;
    document.getElementById("total-productos-papeleria").textContent = pap.totalProductos;
    document.getElementById("unidades-disponibles-papeleria").textContent = pap.unidadesDisponibles;
    document.getElementById("unidades-agotadas-papeleria").textContent = pap.unidadesAgotadas;
    createDoughnutChart("chartPapeleria", ["Disponibles", "Agotadas"], [pap.unidadesDisponibles, pap.unidadesAgotadas], "Estado de Papeler√≠a");

    // Ocultar el loader al final
    hideGlobalLoader();
  }

  // ===== FUNCIONES DE GRAFICADO =====
  function createBarChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label, data }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  function createLineChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label, data, fill: false, tension: 0.3 }] },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });
  }

  function createDoughnutChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "doughnut",
      data: { labels, datasets: [{ label, data }] },
      options: { responsive: true, cutout: "60%" }
    });
  }

  // --- Ocultar loader ---
  function hideGlobalLoader() {
  try {
    // Intentar ocultar el loader local si existe
    const localLoader = document.getElementById("loadingOverlay");
    if (localLoader) {
      localLoader.style.transition = "opacity 0.5s ease";
      localLoader.style.opacity = "0";
      setTimeout(() => (localLoader.style.display = "none"), 500);
      console.log("‚úÖ Loader ocultado en el documento actual.");
      return;
    }

    // Si no existe en este documento, emitir evento para que App.html lo oculte
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: "HIDE_LOADER" }, "*");
      console.log("üì© Evento enviado al padre para ocultar el loader.");
    }
  } catch (e) {
    console.warn("‚ö†Ô∏è No se pudo ocultar el loader:", e);
  }
}


  function showError(err) {
    console.error("‚ö†Ô∏è Error en dashboard:", err);
    alert("No se pudieron cargar los datos del dashboard.");
  }
})();
</script>