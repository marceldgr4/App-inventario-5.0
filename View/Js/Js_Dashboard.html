
<script>
(() => {
  console.log("üìä Iniciando carga del dashboard...");

  google.script.run
    .withSuccessHandler(updateDashboard)
    .withFailureHandler((err) => {
      console.error("‚ùå Error al obtener datos:", err);
      alert("Error al cargar datos del dashboard");
    })
    .obtenerDatosDashboard();

  function updateDashboard(data) {
    console.log("‚úÖ Datos recibidos:", data);
    if (data.error) return showError(data.error);

    // --- INVENTARIO ---
    const inv = data.inventario;
    if (inv) {
        document.getElementById("total-productos-inventario").textContent = inv.totalProductos || 0;
        document.getElementById("unidades-disponibles-inventario").textContent = inv.unidadesDisponibles || 0;
        document.getElementById("unidades-agotadas-inventario").textContent = inv.unidadesAgotadas || 0;
        document.getElementById("mas-ocho-meses").textContent = inv.masDeOchoMeses || 0;
        createDoughnutChart("chartInventarioEstado", ["Disponibles", "Agotadas"], [inv.unidadesDisponibles, inv.unidadesAgotadas], "Estado del Inventario");
        createPieChart("chartInventarioViejos", ["> 8 Meses", "< 8 Meses"], [inv.masDeOchoMeses, inv.totalProductos - inv.masDeOchoMeses], "Antig√ºedad de Productos");
        if (inv.programas) {
            createBarChart("chartInventarioUnidadesPrograma", Object.keys(inv.programas), Object.values(inv.programas), "Unidades por Programa");
        }
        if (inv.productosPorPrograma) {
            const top5Inventario = getTopN(inv.productosPorPrograma, 'unidades', 5);
            createBarChart("chartInventario", top5Inventario.map(p => p.producto), top5Inventario.map(p => p.unidades), "Top 5 Productos con m√°s unidades");
        }
    }

    // --- COMIDA ---
    const com = data.comida;
    if (com) {
        document.getElementById("total-productos-comida").textContent = com.totalProductos || 0;
        document.getElementById("unidades-disponibles-comida").textContent = com.unidadesDisponibles || 0;
        document.getElementById("unidades-agotadas-comida").textContent = com.unidadesAgotadas || 0;
        if (com.gastoMensual) {
            createLineChart("chartGastoComida", Object.keys(com.gastoMensual), Object.values(com.gastoMensual), "Gasto Mensual en Comida ($)");
        }
        createDoughnutChart("chartComidaEstado", ["Disponibles", "Agotadas"], [com.unidadesDisponibles, com.unidadesAgotadas], "Estado de la Comida");
        if (com.productos) {
            const top5Comida = getTopN(com.productos, 'unidades', 5);
            createBarChart("chartComidaTop5", top5Comida.map(p => p.producto), top5Comida.map(p => p.unidades), "Top 5 Productos con m√°s unidades");
            const bottom5Comida = getBottomN(com.productos, 'unidades', 5);
            createBarChart("chartComidaBottom5", bottom5Comida.map(p => p.producto), bottom5Comida.map(p => p.unidades), "Top 5 Productos con menos unidades");
        }
    }

    // --- DECORACI√ìN ---
    const dec = data.decoracion;
    if (dec) {
        document.getElementById("total-productos-decoracion").textContent = dec.totalProductos || 0;
        document.getElementById("unidades-disponibles-decoracion").textContent = dec.unidadesDisponibles || 0;
        document.getElementById("unidades-agotadas-decoracion").textContent = dec.unidadesAgotadas || 0;
        if (dec.categorias) {
            createBarChart("chartCategoriasDecoracion", Object.keys(dec.categorias), Object.values(dec.categorias), "Unidades por Categor√≠a");
        }
        if (dec.gastoMensual) {
            createLineChart("chartGastoDecoracion", Object.keys(dec.gastoMensual), Object.values(dec.gastoMensual), "Gasto Mensual Decoraci√≥n ($)");
        }
        createDoughnutChart("chartDecoracionEstado", ["Disponibles", "Agotadas"], [dec.unidadesDisponibles, dec.unidadesAgotadas], "Estado de la Decoraci√≥n");
        if (dec.categorias) {
            createPieChart("chartDecoracionCategoriasPie", Object.keys(dec.categorias), Object.values(dec.categorias), "Distribuci√≥n de Productos por Categor√≠a");
        }
    }

    // --- PAPELER√çA ---
    const pap = data.papeleria;
    if (pap) {
        document.getElementById("total-productos-papeleria").textContent = pap.totalProductos || 0;
        document.getElementById("unidades-disponibles-papeleria").textContent = pap.unidadesDisponibles || 0;
        document.getElementById("unidades-agotadas-papeleria").textContent = pap.unidadesAgotadas || 0;
        createDoughnutChart("chartPapeleria", ["Disponibles", "Agotadas"], [pap.unidadesDisponibles, pap.unidadesAgotadas], "Estado de Papeler√≠a");
        if (pap.productos) {
            const top5Papeleria = getTopN(pap.productos, 'unidades', 5);
            createBarChart("chartPapeleriaTop5", top5Papeleria.map(p => p.producto), top5Papeleria.map(p => p.unidades), "Top 5 Productos con m√°s unidades");
            const bottom5Papeleria = getBottomN(pap.productos, 'unidades', 5);
            createBarChart("chartPapeleriaBottom5", bottom5Papeleria.map(p => p.producto), bottom5Papeleria.map(p => p.unidades), "Top 5 Productos con menos unidades");
        }
    }

    // Ocultar el loader al final
    hideGlobalLoader();
  }

  function getTopN(arr, prop, n) {
    return arr.slice().sort((a, b) => b[prop] - a[prop]).slice(0, n);
  }

  function getBottomN(arr, prop, n) {
    return arr.slice().sort((a, b) => a[prop] - b[prop]).slice(0, n);
  }

  // ===== FUNCIONES DE GRAFICADO =====
  function createBarChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: [{ label, data }] },
      options: { responsive: true, scales: { y: { beginAtZero: true } } },
    });
  }

  function createLineChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label, data, fill: false, tension: 0.3 }] },
      options: { responsive: true, plugins: { legend: { display: true } } },
    });
  }

  function createDoughnutChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "doughnut",
      data: { labels, datasets: [{ label, data }] },
      options: { responsive: true, cutout: "60%" },
    });
  }

  function createPieChart(id, labels, data, label) {
    const ctx = document.getElementById(id);
    if (!ctx) return;
    new Chart(ctx, {
      type: "pie",
      data: { labels, datasets: [{ label, data }] },
      options: { responsive: true },
    });
  }

  // --- Ocultar loader ---
  function hideGlobalLoader() {
  try {
    // Intentar ocultar el loader local si existe
    const localLoader = document.getElementById("loadingOverlay");
    if (localLoader) {
      localLoader.style.transition = "opacity 0.5s ease";
      localLoader.style.opacity = "0";
      setTimeout(() => (localLoader.style.display = "none"), 500);
      console.log("‚úÖ Loader ocultado en el documento actual.");
      return;
    }

    // Si no existe en este documento, emitir evento para que App.html lo oculte
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({ type: "HIDE_LOADER" }, "*");
      console.log("üì© Evento enviado al padre para ocultar el loader.");
    }
  } catch (e) {
    console.warn("‚ö†Ô∏è No se pudo ocultar el loader:", e);
  }
}


  function showError(err) {
    console.error("‚ö†Ô∏è Error en dashboard:", err);
    alert("No se pudieron cargar los datos del dashboard.");
  }
})();
</script>