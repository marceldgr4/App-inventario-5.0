<script>
(function() {
  // --- estado global local ---
  const pageState = {
    fullData: [],
    datosMostrados: [],
    currentPage: 1,
    itemsPerPage: 10,
    productoAEditarId: null,
    productoRetiroSeleccionado: null,
    fechaOrdenAscendente: false,
    productoComentarioSeleccionado: null,
    criterioDeOrden: "Id",
  };

  console.log("[INFO] Js_Papeleria cargado correctamente.");

  // ---------- reutiliza loadDataGenerico, mostrarMensaje, etc. ----------
  // (asumo que Js_Generico ya está cargado y esas funciones existen globalmente)

  // === carga ===
  function loadPapeleria() {
    loadDataGenerico({
      endpoint: "getPapeleriaData",
      tbodyId: "tablaPapeleriaBody",
      noDataId: "noData",
      containerId: "tableContainerPapeleria",
      onSuccess: function(data) {
        pageState.fullData = data || [];
        pageState.currentPage = 1;
        aplicarFiltrosYOrdenarPapeleria();
        if (pageState.fullData.length === 0) {
          const tbody = document.getElementById("tablaPapeleriaBody");
          if (tbody) tbody.innerHTML = "<tr><td colspan='10' style='text-align:center;'>No hay datos de papelería</td></tr>";
          const pag = document.getElementById("papeleriaPagination");
          if (pag) pag.innerHTML = "";
        } else {
          renderPaginatedTable();
        }
      },
      onError: function() { hideLoading(); }
    });
  }

  // === render fila ===
  function rowRenderer(item) {
    const unidades = parseInt(item['Unidades disponibles']) || 0;
    const agotadoClass = unidades === 0 ? 'agotado' : '';
    const imageUrl = item.Imagen || '';
    const fechaIngresoFormateada = formatDate(item['FECHA DE INGRESO']);
    return `
      <td>${item["Id"] || ''}</td>
      <td>${item["PRODUCTO"] || ''}</td>
      <td>${fechaIngresoFormateada}</td>
      <td>${item["Ingresos"] || 0}</td>
      <td>${item["Salidas"] || 0}</td>
      <td class="${agotadoClass}">${unidades}</td>
      <td>
        ${imageUrl ? `<span><ion-icon name="open-outline" class="btn-icon" title="Abrir imagen" onclick="abrirImagenNuevaVentana('${imageUrl.replace(/'/g, "\'")}')"></ion-icon>` : 'N/A'}
      </td>
      <td>
        <button class="btn-modificar" title="Editar" onclick="abrirModalEditar('${item["Id"]}')"><ion-icon name="create-outline"></ion-icon></button>
        <button class="btn-retirar" title="Retirar" onclick="abrirModalRetiro('${item["Id"]}', '${escapeHtml(item["PRODUCTO"])}', ${unidades})"><ion-icon name="bag-handle-outline"></ion-icon></button>
        <button class="btn-comentario" title="Comentar" onclick="abrirModalComentario('${item["Id"]}')"><ion-icon name="chatbubble-ellipses-outline"></ion-icon></button>
        <button class="btn-eliminar" title="Desactivar" onclick="confirmarEliminar('${item["Id"]}', '${escapeHtml(item["PRODUCTO"])}')"><ion-icon name="trash-bin-outline"></ion-icon></button>
      </td>
    `;
  }

  // === paginación y render tabla ===
  function renderPaginatedTable() {
    const tbody = document.getElementById("tablaPapeleriaBody");
    if (!tbody) { console.error("[ERROR] No tbody 'tablaPapeleriaBody'"); return; }
    tbody.innerHTML = "";
    if (!pageState.datosMostrados || pageState.datosMostrados.length === 0) {
      tbody.innerHTML = "<tr><td colspan='12' style='text-align:center;'>No hay productos que coincidan con los filtros.</td></tr>";
      document.getElementById("papeleriaPagination").innerHTML = "";
      return;
    }
    const totalPages = Math.ceil(pageState.datosMostrados.length / pageState.itemsPerPage);
    if (pageState.currentPage > totalPages) pageState.currentPage = 1;
    const start = (pageState.currentPage - 1) * pageState.itemsPerPage;
    const paginatedItems = pageState.datosMostrados.slice(start, start + pageState.itemsPerPage);

    paginatedItems.forEach(item => {
      const row = tbody.insertRow();
      const fechaIngresoStr = item["FECHA DE INGRESO"];
      if (fechaIngresoStr) {
        const fechaIngresoDate = formatDateForComparison(fechaIngresoStr);
        if (fechaIngresoDate) {
          const currentDate = new Date(); currentDate.setHours(0,0,0,0);
          const oneMonthLater = new Date(currentDate); oneMonthLater.setMonth(currentDate.getMonth() + 1);
          if (fechaIngresoDate < currentDate) row.classList.add("vencido");
          else if (fechaIngresoDate.getTime() === currentDate.getTime()) row.classList.add("vencido-hoy");
          else if (fechaIngresoDate < oneMonthLater) row.classList.add("proximo-a-vencer");
        }
      }
      row.innerHTML = rowRenderer(item);
    });
    renderPaginationControls(pageState.datosMostrados.length);
  }

  function renderPaginationControls(totalItems) {
    const paginationDiv = document.getElementById("papeleriaPagination");
    paginationDiv.innerHTML = "";
    const totalPages = Math.ceil(totalItems / pageState.itemsPerPage);
    if (totalPages <= 1) return;
    const maxButtons = 5;
    let buttonsHtml = '';
    buttonsHtml += `<button class="page-btn" onclick="changePage(pageState.currentPage - 1)" ${pageState.currentPage === 1 ? "disabled" : ""}>Anterior</button>`;
    let startPage = Math.max(1, pageState.currentPage - Math.floor(maxButtons / 2));
    let endPage = Math.min(totalPages, startPage + maxButtons - 1);
    if (endPage === totalPages) startPage = Math.max(1, totalPages - maxButtons + 1);
    if (startPage > 1) {
      buttonsHtml += `<button class="page-btn" onclick="changePage(1)">1</button>`;
      if (startPage > 2) buttonsHtml += `<span class="pagination-dots">...</span>`;
    }
    for (let i = startPage; i <= endPage; i++) {
      const activeClass = i === pageState.currentPage ? "active" : "";
      buttonsHtml += `<button class="page-btn ${activeClass}" onclick="changePage(${i})">${i}</button>`;
    }
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) buttonsHtml += `<span class="pagination-dots">...</span>`;
      buttonsHtml += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }
    buttonsHtml += `<button class="page-btn" onclick="changePage(pageState.currentPage + 1)" ${pageState.currentPage === totalPages ? "disabled" : ""}>Siguiente</button>`;
    paginationDiv.innerHTML = buttonsHtml;
  }

  window.changePage = function(page) {
    const totalPages = Math.ceil(pageState.datosMostrados.length / pageState.itemsPerPage) || 1;
    pageState.currentPage = Math.max(1, Math.min(page, totalPages));
    renderPaginatedTable();
  };

  // === FILTROS y ORDENAMIENTO (corregido: IDs que usa tu HTML) ===
  function aplicarFiltrosYOrdenarPapeleria() {
    aplicarFiltrosYOrdenarGenerico({
      dataSource: pageState.fullData,
      setResultados: val => { pageState.datosMostrados = val; pageState.currentPage = 1; },
      fechaOrdenAsc: pageState.fechaOrdenAscendente,
      renderFn: renderPaginatedTable,
      filters: [
        { id: "buscarPapeleria", field: "PRODUCTO", type: "text" },                    // input de búsqueda principal
        { id: "filtroFechaIngreso", field: "FECHA DE INGRESO", type: "date" },         // si existe
        { id: "filtroUnidadesPapeleria", field: "Unidades disponibles", type: "number" },
        { id: "filtroTiempoStoragePapeleria", field: "TiempoStorage", type: "number" }, // si tu hoja tiene ese campo ajusta 'field'
        { id: "filtroUbicacionPapeleria", field: "Ubicación", type: "text" },         // ajusta 'field' si tu columna se llama distinto
        { id: "filtroEstadoPapeleriaSelect", field: "Estado", type: "text" }
      ]
    });
  }
  const aplicarFiltrosYOrdenar = aplicarFiltrosYOrdenarPapeleria;

  function limpiarTodosLosFiltrosPapeleria() {
    limpiarFiltrosGenerico({
      filtros: [
        { id: "buscarPapeleria", type: "text" },
        { id: "filtroFechaIngreso", type: "date" },
        { id: "filtroUnidadesPapeleria", type: "number" },
        { id: "filtroTiempoStoragePapeleria", type: "number" },
        { id: "filtroUbicacionPapeleria", type: "text" },
        { id: "filtroEstadoPapeleriaSelect", type: "select", defaultValue: "activo" }
      ],
      aplicarFn: aplicarFiltrosYOrdenarPapeleria
    });
  }

  // === funciones exclusivas ===
  function searchItemsPapeleria() { searchItemsGenerico(aplicarFiltrosYOrdenarPapeleria); }
  function clearSearchPapeleria() { clearSearchGenerico("buscarPapeleria", aplicarFiltrosYOrdenarPapeleria); }
  function ordenarPorFechaPapeleria(event) { ordenarPorFechaGenerico(event, "sortOptionsPapeleria"); }
  function ordenarAscendentePapeleria() { ordenarAscendenteGenerico(aplicarFiltrosYOrdenarPapeleria, "sortOptionsPapeleria", val => pageState.fechaOrdenAscendente = val); }
  function ordenarDescendentePapeleria() { ordenarDescendenteGenerico(aplicarFiltrosYOrdenarPapeleria, "sortOptionsPapeleria", val => pageState.fechaOrdenAscendente = val); }
  function toggleFiltrosAdicionalesPapeleria() { toggleFiltrosAdicionalesGenerico("filtrosAdicionalesContainer"); }
  function ordenarPorIdRecientePapeleria() { ordenarPorIdRecienteGenerico(aplicarFiltrosYOrdenarPapeleria, "sortOptionsPapeleria", val => pageState.criterioDeOrden = val); }

  // === MODALES ===
   function abrirModalAgregar() {
    abrirModal("modalAgregarPapeleria");
    document.getElementById("agregarPapeleriaForm").reset();
  }
  function cerrarModalAgregar() { cerrarModal("modalAgregarPapeleria"); }

  function abrirModalEditar(id) {
    const producto = pageState.datosMostrados.find(p => String(p.Id) === String(id));
    if (!producto) return mostrarMensaje("Producto no encontrado", "error");
    pageState.productoAEditarId = id;
    abrirModal("modalEditarPapeleria");
    document.getElementById("productoIdEditarPapeleria").textContent = id;
    document.getElementById("productoEditarPapeleria").value = producto["PRODUCTO"] || "";
    document.getElementById("unidadesAgregarEditarPapeleria").value = "0";
    document.getElementById("imagenEditarPapeleria").value = producto["Imagen"] || "";
  }
  function cerrarModalEditar() { cerrarModal("modalEditarPapeleria"); }

  function abrirModalRetiro(id, producto, unidades) {
    pageState.productoRetiroSeleccionado = { id, producto, unidadesDisponibles: unidades };
    abrirModal("modalRetiroPapeleria");
    document.getElementById("productoIdRetiroPapeleria").textContent = id;
    document.getElementById("productoNombreRetiroPapeleria").textContent = producto;
    document.getElementById("unidadesDisponiblesRetiroPapeleria").textContent = unidades;
  }
  function cerrarModalRetiro() { cerrarModal("modalRetiroPapeleria"); }

  function abrirModalComentario(id) {
    const producto = pageState.datosMostrados.find(p => String(p.Id) === String(id));
    if (!producto) return mostrarMensaje("Producto no encontrado", "error");
    pageState.productoComentarioSeleccionado = { Id: id, producto: producto["PRODUCTO"] };
    abrirModal("modalComentarioPapeleria");
    document.getElementById("comentarioProductoIdPapeleria").textContent = id;
    document.getElementById("comentarioProductoNombrePapeleria").textContent = producto["PRODUCTO"];
  }
  function cerrarModalComentario() { cerrarModal("modalComentarioPapeleria"); }

  // === FORM HANDLERS ===
  document.getElementById("agregarPapeleriaForm")?.addEventListener("submit", e => {
    e.preventDefault();
    const data = {
      productoAgregar: document.getElementById("productoAgregarPapeleria").value,
      ingresosAgregar: parseFloat(document.getElementById("ingresosAgregarPapeleria").value),
      imagenAgregar: "" // pendiente si manejas imágenes
    };
    google.script.run
      .withSuccessHandler(r => handleServerResponse(r, () => cerrarModal('modalAgregarPapeleria'), loadPapeleria))
      .withFailureHandler(handleServerError)
      .agregarPapeleria(data);
  });

  document.getElementById("editarPapeleriaForm")?.addEventListener("submit", e => {
    e.preventDefault();
    const data = {
      idEditar: pageState.productoAEditarId,
      productoEditar: document.getElementById("productoEditarPapeleria").value,
      unidadesAgregarEditar: parseFloat(document.getElementById("unidadesAgregarEditarPapeleria").value),
      imagenEditar: document.getElementById("imagenEditarPapeleria").value
    };
    google.script.run
      .withSuccessHandler(r => handleServerResponse(r, () => cerrarModal('modalEditarPapeleria'), loadPapeleria))
      .withFailureHandler(handleServerError)
      .actualizarPapeleria(data);
  });

  document.getElementById("retiroPapeleriaForm")?.addEventListener("submit", e => {
    e.preventDefault();
    const unidades = parseInt(document.getElementById("unidadesRetirarPapeleria").value);
    google.script.run
      .withSuccessHandler(r => handleServerResponse(r, () => cerrarModal('modalRetiroPapeleria'), loadPapeleria))
      .withFailureHandler(handleServerError)
      .retirarPapeleria(pageState.productoRetiroSeleccionado.id, unidades);
  });

 const formComentario = document.getElementById("comentarioPapeleriaForm");
formComentario?.addEventListener("submit", function(e) {
  e.preventDefault();
  showLoading(true);

  if (!pageState.productoComentarioSeleccionado) {
    hideLoading();
    mostrarMensaje("No se ha seleccionado ningún producto para comentar.", "error");
    return;
  }

  const comentarioTexto = document.getElementById("comentarioTextoPapeleria").value.trim();
  if (!comentarioTexto) {
    hideLoading();
    mostrarMensaje("Por favor, ingrese un comentario.", "error");
    return;
  }

  google.script.run
    .withSuccessHandler(function(responseString) {
      const resp = JSON.parse(responseString);
      if (resp.success) {
        mostrarMensaje(
          `Comentario agregado a ${resp.producto} por ${resp.usuario} el ${new Date(resp.fecha).toLocaleString()}`,
          "success"
        );
        cerrarModal('modalComentarioPapeleria');
        loadPapeleria();
      } else {
        mostrarMensaje("Error: " + resp.error, "error");
      }
      hideLoading();
    })
    .withFailureHandler(handleServerError)
   agregarComentarioGenerico(
    "Papeleria", // 👈 cambia según el módulo
    pageState.productoComentarioSeleccionado.Id,
    comentarioTexto
  );
});


  // === ELIMINAR ===
  function confirmarEliminar(id, producto) {
    if (confirm("¿Desactivar producto " + producto + " (" + id + ")?")) {
      google.script.run
        .withSuccessHandler(r => handleServerResponse(r, null, loadPapeleria))
        .withFailureHandler(handleServerError)
        .eliminarPapeleria(id);
    }
  }

  // === utility: guardarPapeleria (sin cambios de lógica) ===
  function guardarPapeleria() {
    const inputPrecio = document.getElementById("precioAgregarPapeleria");
    if (!validarFormatoPrecio(inputPrecio)) return;
    const precio = convertirPrecioFormateadoAStringNumericoParaServidor(inputPrecio.value);
    console.log("💾 Guardar Papelería con precio:", precio);
  }

  // === inicialización ===
  function inicializarPaginaPapeleria() {
    const setupFilterListener = (id, eventType, handler) => {
      const element = document.getElementById(id);
      if (element) element.addEventListener(eventType, handler);
    };
    setupFilterListener("buscarPapeleria", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroUbicacionPapeleria", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroEstadoPapeleriaSelect", "change", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroUnidadesPapeleria", "input", aplicarFiltrosYOrdenar);
    setupFilterListener("filtroTiempoStoragePapeleria", "input", aplicarFiltrosYOrdenar);

    const toggleFiltrosBtn = document.getElementById("toggleFiltrosPapeleriaIconContainer");
    const filtrosContainer = document.getElementById("filtrosAdicionalesContainer");
    if (toggleFiltrosBtn && filtrosContainer) {
      filtrosContainer.classList.add("filtros-adicionales-ocultos");
      toggleFiltrosBtn.addEventListener("click", toggleFiltrosAdicionalesPapeleria);
    }

    loadPapeleria();
  }

  registrarEscapeCierraModales([ cerrarModalAgregar, cerrarModalEditar, cerrarModalRetiro, cerrarModalComentario ]);

  // === EXPONER ALIAS GLOBALES (para que los onclick inline funcionen) ===
  // mapea tanto nombres con sufijo como sin sufijo (para compatibilidad)
  window.abrirModalAgregar = abrirModalAgregar;
  window.cerrarModalAgregar = cerrarModalAgregar;
  window.abrirModalAgregarPapeleria = abrirModalAgregar;
  window.cerrarModalAgregarPapeleria = cerrarModalAgregar;

  window.abrirModalEditar = abrirModalEditar;
  window.cerrarModalEditar = cerrarModalEditar;
  window.abrirModalEditarPapeleria = abrirModalEditar;
  window.cerrarModalEditarPapeleria = cerrarModalEditar;

 window.abrirModalAgregar = abrirModalAgregar;
  window.cerrarModalAgregar = cerrarModalAgregar;
  window.abrirModalEditar = abrirModalEditar;
  window.cerrarModalEditar = cerrarModalEditar;
  window.abrirModalRetiro = abrirModalRetiro;
  window.cerrarModalRetiro = cerrarModalRetiro;
  window.abrirModalComentario = abrirModalComentario;
  window.cerrarModalComentario = cerrarModalComentario;
  window.confirmarEliminar = confirmarEliminar;
  window.confirmarEliminarPapeleria = confirmarEliminar;

  window.aplicarFiltrosYOrdenar = aplicarFiltrosYOrdenar;
  window.aplicarFiltrosYOrdenarPapeleria = aplicarFiltrosYOrdenarPapeleria;
  window.limpiarTodosLosFiltros = limpiarTodosLosFiltrosPapeleria;
  window.limpiarTodosLosFiltrosPapeleria = limpiarTodosLosFiltrosPapeleria;

  window.ordenarPorFecha = ordenarPorFechaPapeleria;
  window.ordenarAscendente = ordenarAscendentePapeleria;
  window.ordenarDescendente = ordenarDescendentePapeleria;

  // iniciar
  inicializarPaginaPapeleria();

  // =================================================
  // --- LÓGICA DE NOTIFICACIONES DE COMENTARIOS ---
  // =================================================
  function loadNotificacionesComentarios() {
      google.script.run
          .withSuccessHandler(function(comentarios) {
              if (Array.isArray(comentarios)) {
                  renderizarTablasComentarios(comentarios);
                  actualizarIconoComentarios(comentarios.length);
              }
          })
          .withFailureHandler(handleServerError)
          .getComentariosPorHoja("Inventario papeleria");
  }

  function renderizarTablasComentarios(comentarios) {
      const pendientesBody = document.getElementById('tablaComentariosPendientesBody');
      const leidasBody = document.getElementById('tablaComentariosLeidasBody');
      pendientesBody.innerHTML = '';
      leidasBody.innerHTML = '';

      // Aquí puedes agregar lógica para separar entre pendientes y leídos si tienes un campo 'Estado' en tus comentarios.
      // Por ahora, todos se mostrarán como pendientes.
      if (comentarios.length === 0) {
          pendientesBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No hay comentarios.</td></tr>`;
          return;
      }

      comentarios.forEach(c => {
          const row = `
              <tr>
                  <td>${c.ID || ''}</td>
                  <td>${c.PRODUCTO || ''}</td>
                  <td>${formatDate(c.FECHA)}</td>
                  <td>${escapeHtml(c.COMENTARIO || '')}</td>
              </tr>`;
          pendientesBody.innerHTML += row;
      });
  }

  function actualizarIconoComentarios(count) {
      const container = document.getElementById('notificacionContainerPapeleria');
      const span = container ? container.querySelector('span') : null;
      if (span) {
          span.textContent = count;
          span.style.display = count > 0 ? 'inline-block' : 'none';
      }
  }

  window.abrirModalComentariosPapeleria = function() {
      abrirModal('modalNotificacion-Comentario');
      loadNotificacionesComentarios();
  };
  window.cerrarModalNotificaciones = function() { cerrarModal('modalNotificacion-Comentario'); };
})();
</script>
