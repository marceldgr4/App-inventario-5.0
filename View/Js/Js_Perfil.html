<script>
    /**
     * Se ejecuta cuando el DOM está completamente cargado.
     * Inicia la carga de los datos del perfil y adjunta el manejador de eventos al formulario.
     */
    document.addEventListener('DOMContentLoaded', function() {
      loadPerfilData();
      // Asegurar que el formulario exista antes de adjuntar el evento
      const perfilForm = document.getElementById('perfilForm');
      if (perfilForm) {
          perfilForm.addEventListener('submit', handleFormSubmit);
      } else {
          console.error("Error: Elemento 'perfilForm' no encontrado.");
      }
    });

    /**
     * @summary Muestra la superposición de carga.
     */
    function showLoading() {
      const loadingOverlay = document.getElementById('loadingOverlayPerfil');
      if (loadingOverlay) {
        // Asumiendo que 'loadingOverlayPerfil' existe en tu HTML principal
        loadingOverlay.style.display = 'flex';
      }
    }

    /**
     * @summary Oculta la superposición de carga.
     */
    function hideLoading() {
      const loadingOverlay = document.getElementById('loadingOverlayPerfil');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
    }

    /**
     * @summary Muestra un mensaje temporal de feedback al usuario.
     * @param {string} message - El texto del mensaje a mostrar.
     * @param {string} type - El tipo de mensaje ('success' o 'error').
     */
    function showMessage(message, type) {
      const messageDiv = document.getElementById('perfilMessage');
      if (messageDiv) {
        messageDiv.textContent = message;
        messageDiv.className = 'feedback-message ' + type;
        messageDiv.style.display = 'block';

        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
    }

    /**
     * @summary Carga los datos del perfil del usuario actualmente autenticado desde el servidor.
     * **POSIBLE CAUSA DEL ERROR RESUELTA:** Manejo robusto del parseo JSON y la asignación de valores.
     */
    function loadPerfilData() {
      showLoading();
      google.script.run
        .withSuccessHandler(function(responseString) {
          hideLoading();
          try {
            const response = JSON.parse(responseString);
            
            if (response.success && response.data) {
              // Asignación de valores a los inputs, usando el operador de coalescencia nula (|| '') para seguridad
              document.getElementById('nombreCompletoPerfil').value = response.data.nombreCompleto || '';
              document.getElementById('userNamePerfil').value = response.data.userName || '';
              
            } else {
              // Si success es false, o data es nulo/indefinido
              showMessage(response.message || "Error: El servidor no devolvió datos válidos.", "error");
            }
          } catch (e) {
            // Error al parsear la cadena JSON
            console.error("Error de parseo JSON en loadPerfilData:", e, "Respuesta recibida:", responseString);
            showMessage("Error de comunicación con el servidor. Intente más tarde.", "error");
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          // Error en la llamada google.script.run
          console.error("Fallo de RPC en loadPerfilData:", error);
          showMessage("Error del servidor (RPC): " + error.message, "error");
        })
        // Llamada a la función del backend
        .getMiPerfilData(); 
    }

    /**
     * @summary Maneja el evento de envío del formulario de actualización de perfil.
     */
    function handleFormSubmit(event) {
      event.preventDefault();
      showLoading();

      const nombreCompletoInput = document.getElementById('nombreCompletoPerfil');
      const userNameInput = document.getElementById('userNamePerfil');
      const newPasswordInput = document.getElementById('newPasswordPerfil');
      const confirmNewPasswordInput = document.getElementById('confirmNewPasswordPerfil');

      // Comprobación de existencia de elementos antes de acceder a .value
      if (!nombreCompletoInput || !userNameInput || !newPasswordInput || !confirmNewPasswordInput) {
           showMessage("Error interno: Faltan elementos del formulario.", "error");
           hideLoading();
           return;
      }

      const nombreCompleto = nombreCompletoInput.value.trim();
      const userName = userNameInput.value.trim();
      const newPassword = newPasswordInput.value;
      const confirmNewPassword = confirmNewPasswordInput.value;

      if (!nombreCompleto || !userName) {
        showMessage("Nombre completo y nombre de usuario son obligatorios.", "error");
        hideLoading();
        return;
      }

      if (newPassword !== "") {
        if (newPassword !== confirmNewPassword) {
          showMessage("Las nuevas contraseñas no coinciden.", "error");
          hideLoading();
          return;
        }
        if (!/^[a-zA-Z]/.test(newPassword)) {
          showMessage("La nueva contraseña debe comenzar con una letra, tal como requiere el servidor.", "error");
          hideLoading();
          return;
        }
      }

      const formData = {
        nombreCompleto: nombreCompleto,
        userName: userName,
        newPassword: newPassword
      };

      google.script.run
        .withSuccessHandler(function(responseString) {
          hideLoading();
           try {
            const response = JSON.parse(responseString);
            if (response.success) {
              showMessage(response.message, "success");
              loadPerfilData();
              // Limpiar campos de contraseña después de un éxito
              newPasswordInput.value = "";
              confirmNewPasswordInput.value = "";
            } else {
              showMessage(response.message || "Error al actualizar el perfil.", "error");
            }
          } catch (e) {
            showMessage("Error al procesar respuesta del servidor para la actualización: " + e.message, "error");
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showMessage("Error del servidor al actualizar: " + error.message, "error");
        })
        .actualizarMiPerfil(formData);
    }
</script>