<script>
(function(){
  console.log('[PERFIL DIAG] Script de Perfil iniciado.');

  // Helpers: usar las funciones genéricas si están disponibles
  function showLoadingLocal(){ if(typeof showLoading === 'function') showLoading(true); else { const el = document.getElementById('loadingOverlay'); if(el) el.style.display = 'flex'; }}
  function hideLoadingLocal(){ if(typeof hideLoading === 'function') hideLoading(); else { const el = document.getElementById('loadingOverlay'); if(el) el.style.display = 'none'; }}
  function showMessageLocal(msg, type){ if(typeof mostrarMensaje === 'function') mostrarMensaje(msg, type); else { const el = document.getElementById('perfilMessage'); if(el){ el.textContent = msg; el.className = 'feedback-message ' + (type||'info'); el.style.display = 'block'; setTimeout(()=> el.style.display='none',5000);} else alert(msg); }}

  // Inicialización de handlers
  function attachFormHandler(){
    const perfilForm = document.getElementById('perfilForm');
    if (perfilForm) {
      perfilForm.removeEventListener('submit', handleFormSubmit);
      perfilForm.addEventListener('submit', handleFormSubmit);
      console.log('[PERFIL DIAG] submit handler adjuntado.');
    } else {
      console.warn("[PERFIL DIAG] Elemento 'perfilForm' no encontrado al adjuntar handler.");
    }
  }

  // Normalizar respuesta del servidor (acepta string o objeto)
  function normalizeResponse(resp){
    if(!resp) return null;
    if(typeof resp === 'string'){
      try{ return JSON.parse(resp); } catch(e){ console.error('[PERFIL DIAG] fallo al parsear string respuesta:', e); return null; }
    }
    return resp;
  }

  // Carga de datos del perfil con timeout de seguridad
  function loadPerfilData(){
    showLoadingLocal();
    console.log('[PERFIL DIAG] solicitando getMiPerfilData()...');

    const timeoutId = setTimeout(()=>{
      console.error('[PERFIL DIAG] Timeout: getMiPerfilData tardó demasiado. Ocultando loading.');
      hideLoadingLocal();
      showMessageLocal('El servidor no respondió a tiempo al cargar el perfil. Revisa logs.', 'error');
    }, 15000);

    if(typeof google === 'undefined' || !google.script || !google.script.run){
      console.error('[PERFIL DIAG] google.script.run no disponible');
      clearTimeout(timeoutId);
      hideLoadingLocal();
      showMessageLocal('google.script.run no está disponible. Abre la WebApp correctamente.', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function(response){
        clearTimeout(timeoutId);
        console.log('[PERFIL DIAG] getMiPerfilData success', response);
        const res = normalizeResponse(response);
        hideLoadingLocal();
        if(!res){
          showMessageLocal('Respuesta inválida del servidor.', 'error');
          return;
        }
        if(res.success && res.data){
          // Asignar valores de forma segura
          const nombreEl = document.getElementById('nombreCompletoPerfil');
          const userEl = document.getElementById('userNamePerfil');
          if(nombreEl) nombreEl.value = res.data.nombreCompleto || '';
          if(userEl) userEl.value = res.data.userName || '';
          console.log('[PERFIL DIAG] Perfil cargado en la UI.');
        } else {
          showMessageLocal(res.message || 'No se pudieron obtener los datos del perfil.', 'error');
        }
      })
      .withFailureHandler(function(err){
        clearTimeout(timeoutId);
        console.error('[PERFIL DIAG] getMiPerfilData failure', err);
        hideLoadingLocal();
        showMessageLocal('Error al cargar perfil: ' + (err && err.message ? err.message : err), 'error');
      })
      .getMiPerfilData();
  }

  // Manejo del submit del formulario
  function handleFormSubmit(evt){
    evt.preventDefault();
    showLoadingLocal();
    console.log('[PERFIL DIAG] Enviando actualizarMiPerfil...');

    const nombreEl = document.getElementById('nombreCompletoPerfil');
    const userEl = document.getElementById('userNamePerfil');
    const newPwdEl = document.getElementById('newPasswordPerfil');
    const confirmPwdEl = document.getElementById('confirmNewPasswordPerfil');

    if(!nombreEl || !userEl){
      showMessageLocal('Formulario incompleto.', 'error');
      hideLoadingLocal();
      return;
    }

    const payload = {
      nombreCompleto: nombreEl.value.trim(),
      userName: userEl.value.trim(),
      newPassword: newPwdEl ? newPwdEl.value : ''
    };

    const timeoutId = setTimeout(()=>{
      console.error('[PERFIL DIAG] Timeout: actualizarMiPerfil tardó demasiado.');
      hideLoadingLocal();
      showMessageLocal('El servidor no respondió a tiempo al actualizar el perfil.', 'error');
    }, 15000);

    if(typeof google === 'undefined' || !google.script || !google.script.run){
      clearTimeout(timeoutId);
      hideLoadingLocal();
      showMessageLocal('google.script.run no disponible.', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function(response){
        clearTimeout(timeoutId);
        console.log('[PERFIL DIAG] actualizarMiPerfil success', response);
        const res = normalizeResponse(response);
        hideLoadingLocal();
        if(!res){ showMessageLocal('Respuesta inválida al actualizar.', 'error'); return; }
        if(res.success){
          showMessageLocal(res.message || 'Perfil actualizado.', 'success');
          // limpiar contraseñas
          if(newPwdEl) newPwdEl.value = '';
          if(confirmPwdEl) confirmPwdEl.value = '';
          // recargar datos
          loadPerfilData();
        } else {
          showMessageLocal(res.message || 'Error al actualizar perfil.', 'error');
        }
      })
      .withFailureHandler(function(err){
        clearTimeout(timeoutId);
        console.error('[PERFIL DIAG] actualizarMiPerfil failure', err);
        hideLoadingLocal();
        showMessageLocal('Error al actualizar perfil: ' + (err && err.message ? err.message : err), 'error');
      })
      .actualizarMiPerfil(payload);
  }

  // Inicialización robusta
  function initializeApp(){
    console.log('[PERFIL DIAG] initializeApp: adjuntando handlers y cargando perfil');
    attachFormHandler();
    loadPerfilData();
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initializeApp);
    console.log('[PERFIL DIAG] Registrado listener DOMContentLoaded.');
  } else {
    console.log('[PERFIL DIAG] document.readyState:', document.readyState, '- ejecutando initializeApp inmediatamente.');
    initializeApp();
  }

  console.log('[PERFIL DIAG] Script de Perfil: fin del bloque.');

})();
</script>