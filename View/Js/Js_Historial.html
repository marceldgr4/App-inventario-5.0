<script>
(function () {
  // =================================================
  // --- VARIABLES DE ESTADO DE LA PÁGINA DE HISTORIAL ---
  // =================================================
  const pageState = {
    fullData: [],
    datosMostrados: [],
    currentPage: 1,
    itemsPerPage: 10,
    fechaOrdenAscendente: false,
  };

  // =================================================
  // --- CARGA DE DATOS ---
  // =================================================
  function loadHistorial() {
    loadDataGenerico({
      endpoint: "getHistorialData",
      onSuccess: (data) => {
        pageState.fullData = data;
        pageState.currentPage = 1;
        aplicarFiltrosYOrdenar();
      },
      tbodyId: "tablaHistorialBody",
    });
  }

  // ============================================
  // --- RENDERIZADO DE TABLA Y PAGINACIÓN ---
  // ============================================
  function renderPaginatedTable() {
    renderPaginatedTableGeneric({
      data: pageState.datosMostrados,
      currentPage: pageState.currentPage,
      itemsPerPage: pageState.itemsPerPage,
      tbodyId: "tablaHistorialBody",
      paginationContainerId: "historialPagination",
      noDataMessage: "No hay registros en el historial.",
      onRowCreated: (row, item) => {
        row.dataset.id = item["Id"] || "";
        row.dataset.productoId = item["ProductoId"] || "";
      },
      renderRow: (item) => {
        return `
          <td>${escapeHtml(item["Id"] || "")}</td>
          <td>${escapeHtml(item["ProductoId"] || "")}</td>
          <td>${formatDate(item["Fecha"])}</td>
          <td>${escapeHtml(item["Producto"] || "")}</td>
          <td>${escapeHtml(item["Programa"] || "")}</td>
          <td>${item["Unidades Anteriores"] == null ? "-" : escapeHtml(String(item["Unidades Anteriores"]))}</td>
          <td>${item["Unidades Nuevas"] == null ? "-" : escapeHtml(String(item["Unidades Nuevas"]))}</td>
          <td>${escapeHtml(item["Estado"] || "")}</td>
          <td>${escapeHtml(item["Usuario"] || "")}</td>
          <td>${formatDate(item["Fecha de Retiro"])}</td>
          <td>${item["Cantidad"] == null ? "-" : escapeHtml(String(item["Cantidad"]))}</td>
        `;
      },
      onPageChange: (page) => {
        pageState.currentPage = page;
        renderPaginatedTable();
      },
    });
  }

  // =================================================
  // --- FILTROS Y ORDENAMIENTO ---
  // =================================================
  function aplicarFiltrosYOrdenar() {
    const filters = [
      {
        id: "buscarHistorial",
        fields: ["Producto", "Usuario"],
        type: "text",
      },
      {
        id: "filtroProgramaHistorial",
        fields: ["Programa"],
        type: "text",
      },
      {
        id: "filtroEstadoHistorialInput",
        fields: ["Estado"],
        type: "text",
      }
    ];

    aplicarFiltrosYOrdenarGenerico({
      dataSource: pageState.fullData,
      setResultados: (resultados) => (pageState.datosMostrados = resultados),
      filters: filters,
      fechaOrdenAsc: pageState.fechaOrdenAscendente,
      campoFecha: "Fecha",
      renderFn: renderPaginatedTable,
    });
  }

  function limpiarTodosLosFiltrosHistorial() {
    const inputs = [
      "buscarHistorial",
      "filtroProgramaHistorial",
      "filtroEstadoHistorialInput"
    ];
    
    inputs.forEach(id => {
      const input = document.getElementById(id);
      if (input) input.value = "";
    });
    
    aplicarFiltrosYOrdenar();
  }

  function toggleFiltrosAdicionalesHistorial() {
    const container = document.getElementById("filtrosAdicionalesHistorialContainer");
    if (container) {
      container.classList.toggle("filtros-adicionales-ocultos");
    }
  }

  // ===============================================
  // --- INICIALIZACIÓN Y EXPOSICIÓN GLOBAL ---
  // ===============================================
  function inicializarPaginaHistorial() {
    // Configurar listeners de filtros
    const inputIds = ["buscarHistorial", "filtroProgramaHistorial", "filtroEstadoHistorialInput"];
    inputIds.forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener("input", aplicarFiltrosYOrdenar);
      }
    });

    const toggleFiltrosBtnEl = document.getElementById("toggleFiltrosHistorialIconContainer");
    if (toggleFiltrosBtnEl) {
      toggleFiltrosBtnEl.addEventListener("click", toggleFiltrosAdicionalesHistorial);
    }

    // Cargar datos iniciales
    loadHistorial();
  }

  // Exponer funciones necesarias al scope global para los onclick del HTML
  window.ordenarPorFechaHistorial = (e) => ordenarPorFechaGenerico(e, "sortOptions");
  window.ordenarAscendenteHistorial = () =>
    ordenarAscendenteGenerico(
      aplicarFiltrosYOrdenar,
      "sortOptions",
      (val) => (pageState.fechaOrdenAscendente = val)
    );
  window.ordenarDescendenteHistorial = () =>
    ordenarDescendenteGenerico(
      aplicarFiltrosYOrdenar,
      "sortOptions",
      (val) => (pageState.fechaOrdenAscendente = val)
    );
  window.buscarPorNombreHistorial = aplicarFiltrosYOrdenar;
  window.limpiarTodosLosFiltrosHistorial = limpiarTodosLosFiltrosHistorial;
  window.cerrarMensajeHistorial = () => {
    const mensajeDiv = document.getElementById("mensajeConfirmacionHistorial");
    if (mensajeDiv) mensajeDiv.style.display = "none";
  };

  // Inicializar la página
  inicializarPaginaHistorial();
})();</script>