<script>
  //v12
  (function () {
    // =================================================
    // --- VARIABLES DE ESTADO DE LA P√ÅGINA
    // =================================================
    const pageState = {
      fullData: [],
      datosMostrados: [],
      currentPage: 1,
      itemsPerPage: 10,
      productoAEditarId: null,
      productoRetiroSeleccionado: null,
      fechaOrdenAscendente: false,
      productoComentarioSeleccionado: null,
      productosViejosGlobal: [],
      paginaActualNotificaciones: 1,
      elementosPorPaginaNotificaciones: 10,
    };

    // =======================================
    // --- 1. CARGA DE DATOS Y MANEJO DE RESPUESTAS ---
    // =======================================
    function loadInventario() {
      loadDataGenerico({
        endpoint: "getInventarioData",
        tbodyId: "tablaBody",
        noDataId: "noData",
        containerId: "tableContainer",
        onSuccess: function (data) {
          pageState.fullData = data;
          pageState.currentPage = 1;
          aplicarFiltrosYOrdenar();
          if (pageState.fullData.length === 0) {
            document.getElementById("noData").style.display = "block";
          } else {
            document.getElementById("noData").style.display = "none";
            document.getElementById("tableContainer").style.display = "block";
          }
          // Cargar notificaciones despu√©s de que la tabla principal est√© lista
          loadNotificacioensArticulos();
        },
      });
    }

    function loadNotificacioensArticulos() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (responseString) {
          hideLoading();
          try {
            const productosServer = JSON.parse(responseString);
            if (Array.isArray(productosServer)) {
              pageState.productosViejosGlobal = productosServer;
              pageState.paginaActualNotificaciones = 1;
              renderizarTablaNotificaciones();
              updateNotificationIcon();
            } else {
              console.error(
                "Formato de respuesta inesperado de getArticulosViejos:",
                productosServer
              );
            }
          } catch (e) {
            console.error(
              "Error parseando la respuesta de getArticulosViejos:",
              e,
              responseString
            );
          }
        })
        .withFailureHandler(function (error) {
          hideLoading();
          console.error("Error al obtener productos viejos:", error);
          mostrarMensaje(
            "Error de comunicaci√≥n al cargar notificaciones: " + error.message,
            "error"
          );
        })
        .getArticulosViejos();
    }

    // ============================================
    // --- 2. RENDERIZADO DE TABLA Y PAGINACI√ìN ---
    // ============================================
    function renderPaginatedTable() {
      renderPaginatedTableGeneric({
        data: pageState.datosMostrados,
        currentPage: pageState.currentPage,
        itemsPerPage: pageState.itemsPerPage,
        tbodyId: "tablaBody",
        paginationContainerId: "pagination",
        noDataMessage: "No hay productos que coincidan con los filtros.",
        onRowCreated: (row, item) => {
          const ingresos = parseInt(item["Ingresos"]) || 0;
          const salidas = parseInt(item["Salidas"]) || 0;
          const unidades =
            item["Unidades disponibles"] != null &&
            item["Unidades disponibles"] !== ""
              ? parseInt(item["Unidades disponibles"]) || 0
              : ingresos - salidas;

          row.dataset.id = item["Id"] || "";
          row.dataset.producto = item["PRODUCTO"] || "";
          row.dataset.programa = item["PROGRAMA"] || "";
          row.dataset.unidades = unidades;
        },
        renderRow: (item) => {
          const ingresos = parseInt(item["Ingresos"]) || 0;
          const salidas = parseInt(item["Salidas"]) || 0;
          const unidades =
            item["Unidades disponibles"] != null &&
            item["Unidades disponibles"] !== ""
              ? parseInt(item["Unidades disponibles"]) || 0
              : ingresos - salidas;
          const agotadoClass = unidades === 0 ? "agotado" : "";
          const imageUrl = item["Imagen"] || "";

          // üü¢ Cada fila mantiene la misma estructura que ya usabas
          return `
                <td>${item["Id"] || ""}</td>
                <td>${item["PRODUCTO"] || ""}</td>
                <td>${item["PROGRAMA"] || ""}</td>
                <td>${formatDate(item["FECHA DE INGRESO"])}</td>
                <td>${ingresos}</td>
                <td>${salidas}</td>
                <td class="${agotadoClass}">${unidades}</td>
                <td>
                    ${
                      imageUrl
                        ? `<ion-icon name="open-outline" class="btn-icon" title="Abrir imagen" onclick="abrirImagenNuevaVentana('${imageUrl}')"></ion-icon>`
                        : "N/A"
                    }
                </td>
                <td>${formatDate(
                  item["Entregas fecha"] || item["Entregas"] || ""
                )}</td>
                <td>${item["Entregas cantidad"] || ""}</td>
                <td>
                    <button class="btn-modificar"><ion-icon name="create-outline"></ion-icon></button>
                    <button class="btn-retirar"><ion-icon name="bag-handle-outline"></ion-icon></button>
                    <button class="btn-comentario"><ion-icon name="chatbubble-ellipses-outline"></ion-icon></button>
                    <button class="btn-eliminar"><ion-icon name="trash-bin-outline"></ion-icon></button>
                </td>
            `;
        },
        onPageChange: (page) => {
          pageState.currentPage = page;
          renderPaginatedTable();
        },
      });
    }
    // Delegaci√≥n de eventos para los botones de acciones
    document.getElementById("tablaBody")?.addEventListener("click", (e) => {
      const row = e.target.closest("tr");
      if (!row) return;
      const id = row.dataset.id;
      const producto = row.dataset.producto;
      const programa = row.dataset.programa;
      const unidades = parseInt(row.dataset.unidades) || 0;

      if (e.target.closest(".btn-modificar")) abrirModalEditar(id);
      if (e.target.closest(".btn-retirar"))
        abrirModalRetiro(id, producto, programa, unidades);
      if (e.target.closest(".btn-comentario"))
        abrirModalComentario(id, producto, programa);
      if (e.target.closest(".btn-eliminar")) confirmarEliminar(id, producto);
    });
    document
      .getElementById("selectAllNotifications")
      ?.addEventListener("change", handleIndividualCheckboxChange);
    document
      .getElementById("deactivateNotifications")
      ?.addEventListener("click", deactivateSelectedNotifications);
    document
      .getElementById("clearNotifications")
      ?.addEventListener("click", clearNotifications);

    // --- Notificaciones ---
    function renderizarTablaNotificaciones() {
      const items = pageState.productosViejosGlobal.map((item) => {
        const tiempoEnStorageMeses = convertDaysToMonths(
          parseInt(item.tiempoenstorage) || 0
        );
        const esVencido = tiempoEnStorageMeses >= 8;
        const rowHtml = `
                <td>${escapeHtml(item.id || "N/A")}</td>
                <td>${escapeHtml(item.producto || "N/A")}</td>
                <td>${escapeHtml(item.programa || "N/A")}</td>
                <td>${formatDate(item.fechadeingreso)}</td>
                <td>${
                  esVencido
                    ? `<span>‚ö† ${tiempoEnStorageMeses} meses</span>`
                    : `${tiempoEnStorageMeses} meses`
                }</td>
                <td><input type="checkbox" data-id="${escapeHtml(
                  item.id
                )}" class="select-notification-checkbox"></td>
            `;
        return { ...item, _rowHtml: rowHtml };
      });

      renderNotificationsGeneric({
        items,
        page: pageState.paginaActualNotificaciones,
        perPage: pageState.elementosPorPaginaNotificaciones,
        tbodyId: "tablaBodyNotificaciones",
        paginationContainerId: "paginationNotificaciones",
        onPageChange: (p) => {
          pageState.paginaActualNotificaciones = p;
          renderizarTablaNotificaciones();
        },
        checkboxClass: "select-notification-checkbox",
        infoElementId: "infoPaginaNotificaciones",
        noDataMessage: "No hay notificaciones.",
      });
    }

    function updateNotificationIcon() {
      const icon = document.getElementById("notificacionCampanaIcon");
      const count = document.getElementById("notificacionCampanaCount");
      if (icon && count) {
        if (pageState.productosViejosGlobal.length > 0) {
          count.textContent = pageState.productosViejosGlobal.length;
          count.style.display = "inline-block";
          icon.style.cursor = "pointer";
          icon.onclick = abrirModalNotificacionesInterno;
        } else {
          count.style.display = "none";
          icon.style.cursor = "default";
          icon.onclick = null;
        }
      }
    }

    function handleIndividualCheckboxChange() {
      const all = document.querySelectorAll(
        "#tablaBodyNotificaciones .select-notification-checkbox"
      );
      const checked = document.querySelectorAll(
        "#tablaBodyNotificaciones .select-notification-checkbox:checked"
      );
      const selectAll = document.getElementById("selectAllNotifications");
      if (selectAll)
        selectAll.checked = all.length > 0 && all.length === checked.length;
    }

    function deactivateSelectedNotifications() {
      const ids = Array.from(
        document.querySelectorAll(
          "#tablaBodyNotificaciones .select-notification-checkbox:checked"
        )
      )
        .map((cb) => cb.dataset.id)
        .filter((id) => id);
      if (ids.length === 0) {
        mostrarMensaje("Selecciona al menos un producto.", "error");
        return;
      }
      if (confirm(`¬øSeguro que desea dar de baja ${ids.length} producto(s)?`)) {
        showLoading(true);
        google.script.run
          .withSuccessHandler(handleServerResponse)
          .withFailureHandler(handleServerError)
          .deactivateProducts(ids);
      }
    }

    function clearNotifications() {
      pageState.productosViejosGlobal = [];
      renderizarTablaNotificaciones();
      updateNotificationIcon();
      mostrarMensaje("Notificaciones limpiadas.", "success");
    }

    //============================================
    //Notificicaion de comentarios
    //============================================
    function loadComentario() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (responseString) {
          showLoading(false);
          try {
            const response = JSON.parse(responseString);
            if (response.data) {
              renderComentarios(response.data);
            } else {
              console.error("No data in response:", response);
              mostrarMensaje("No se encontraron comentarios.", "info");
            }
          } catch (e) {
            console.error("Error parsing comments response:", e);
            mostrarMensaje(
              "Error al procesar la respuesta de comentarios.",
              "error"
            );
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          console.error("Error loading comments:", error);
          mostrarMensaje("Error al cargar los comentarios.", "error");
        })
        .getComentarioData();
    }

    function renderComentarios(comentarios) {
      const pendientesBody = document.getElementById(
        "tablaComentariosPendientesBody"
      );
      const leidasBody = document.getElementById("tablaComentariosLeidasBody");

      if (!pendientesBody || !leidasBody) {
        console.error("[ERROR] Elementos de comentarios no encontrados");
        return;
      }

      pendientesBody.innerHTML = "";
      leidasBody.innerHTML = "";

      // Assuming comments have a "Leido" property
      const pendientes = comentarios.filter((c) => !c.Leido);
      const leidas = comentarios.filter((c) => c.Leido);

      if (pendientes.length === 0) {
        pendientesBody.innerHTML =
          "<tr><td colspan='4'>No hay comentarios pendientes.</td></tr>";
      } else {
        pendientes.forEach((c) => {
          const row = pendientesBody.insertRow();
          row.innerHTML = `
                    <td>${escapeHtml(c.Id)}</td>
                    <td>${escapeHtml(c.Producto)}</td>
                    <td>${formatDate(c.Fecha)}</td>
                    <td>${escapeHtml(c.Comentario)}</td>
                `;
        });
      }

      if (leidas.length === 0) {
        leidasBody.innerHTML =
          "<tr><td colspan='4'>No hay comentarios le√≠dos.</td></tr>";
      } else {
        leidas.forEach((c) => {
          const row = leidasBody.insertRow();
          row.innerHTML = `
                    <td>${escapeHtml(c.Id)}</td>
                    <td>${escapeHtml(c.Producto)}</td>
                    <td>${formatDate(c.Fecha)}</td>
                    <td>${escapeHtml(c.Comentario)}</td>
                `;
        });
      }
    }

    // =================================================
    // --- 4. FILTROS Y ORDENAMIENTO ---
    // =================================================
    function aplicarFiltrosYOrdenarArticulos() {
      aplicarFiltrosYOrdenarGenerico({
        dataSource: pageState.fullData,
        setResultados: (val) => {
          pageState.datosMostrados = val;
          pageState.currentPage = 1;
        },
        fechaOrdenAsc: pageState.fechaOrdenAscendente,
        renderFn: renderPaginatedTable,
        filters: [
          { id: "buscarProducto", field: "PRODUCTO", type: "text" },
          { id: "filtroPrograma", field: "PROGRAMA", type: "text" },
          { id: "filtroFechaIngreso", field: "FECHA DE INGRESO", type: "date" },
          {
            id: "filtroUnidades",
            field: "Unidades disponibles",
            type: "number",
          },
          {
            id: "filtroTiempoStorage",
            field: "Tiempo en Storage",
            type: "number",
          },
          { id: "filtroEstado", field: "Estado", type: "text" },
        ],
      });
    }
    const aplicarFiltrosYOrdenar = aplicarFiltrosYOrdenarArticulos;

    function limpiarTodosLosFiltrosArticulos() {
      limpiarFiltrosGenerico({
        filtros: [
          { id: "buscarProducto", type: "text" },
          { id: "filtroPrograma", type: "text" },
          { id: "filtroFechaIngreso", type: "date" },
          { id: "filtroUnidades", type: "number" },
          { id: "filtroTiempoStorage", type: "number" },
          { id: "filtroEstado", type: "select", defaultValue: "activo" },
        ],
        aplicarFn: aplicarFiltrosYOrdenarArticulos,
      });
    }

    // ===================================
    // --- 5. MANEJO DE MODALES ---
    // ===================================
    function abrirModalAgregar() {
      abrirModal("modalAgregar");
      document.getElementById("agregarForm").reset();
    }
    function cerrarModalAgregar() {
      cerrarModal("modalAgregar");
    }

    function abrirModalRetiro(id, producto, programa, unidadesDisponibles) {
      pageState.productoRetiroSeleccionado = {
        id,
        producto,
        programa,
        unidadesDisponibles,
      };
      abrirModal("modalRetiro");
      document.getElementById("productoIdRetiro").textContent = id;
      document.getElementById("productoNombreRetiro").textContent = producto;
      document.getElementById("programaRetiro").textContent = programa;
      document.getElementById("unidadesDisponiblesRetiro").textContent =
        unidadesDisponibles;
      document.getElementById("unidadesRetirar").max = unidadesDisponibles;
    }
    function cerrarModalRetiro() {
      cerrarModal("modalRetiro");
      pageState.productoRetiroSeleccionado = null;
    }

    function abrirModalEditar(id) {
      pageState.productoAEditarId = id;
      const producto = pageState.fullData.find(
        (item) => String(item.Id) === String(id)
      );
      if (producto) {
        abrirModal("modalEditar");
        document.getElementById("productoIdEditar").textContent = id;
        document.getElementById("productoEditar").value = producto["PRODUCTO"];
        document.getElementById("programaEditar").value = producto["PROGRAMA"];
        document.getElementById("unidadesAgregarEditar").value = "0";
        document.getElementById("imagenEditar").value =
          producto["Imagen"] || "";
      } else {
        mostrarMensaje(
          "Error: No se pudo encontrar el producto para editar.",
          "error"
        );
      }
    }
    function cerrarModalEditar() {
      cerrarModal("modalEditar");
      pageState.productoAEditarId = null;
    }
    function abrirModalComentario(id, producto, programa) {
      pageState.productoComentarioSeleccionado = { id, producto, programa };
      abrirModal("modalComentario");
      document.getElementById("comentarioProductoId").textContent = id;
      document.getElementById("comentarioProductoNombre").textContent =
        producto;
      document.getElementById("comentarioProductoPrograma").textContent =
        programa;
      document.getElementById("comentarioTexto").value = "";
    }
    function cerrarModalComentario() {
      cerrarModal("modalComentario");
      pageState.productoComentarioSeleccionado = null;
    }
    function abrirModalNotificacionesInterno() {
      abrirModal("modalNotificaciones");
    }
    function cerrarModalNotificaciones() {
      cerrarModal("modalNotificaciones");
    }
    function abrirModalVerImagen(imageUrl) {
      const img = document.getElementById("imagenEnModal");
      if (img && imageUrl) {
        img.src = imageUrl;
        abrirModal("modalVerImagen");
      }
    }
    function cerrarModalVerImagen() {
      cerrarModal("modalVerImagen");
    }
    function abrirModalNotificacionComentario() {
      abrirModal("modalNotificacion-Comentario");
      cargarNotificacionesDeComentariosArticulos();
    }
    function cerrarModalNotificacionComentario() {
      cerrarModal("modalNotificacion-Comentario");
    }

    // =========================================
    // --- 6. MANEJADORES DE ENV√çO DE FORMULARIOS ---
    // =========================================
    (function () {
      // ===========================
      // FORMULARIO: AGREGAR
      // ===========================
      document
        .getElementById("agregarForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const producto = document
            .getElementById("productoAgregar")
            .value.trim();
          const programa = document
            .getElementById("programaAgregar")
            .value.trim();
          const ingresos = document.getElementById("ingresosAgregar").value;
          const imagenInput = document.getElementById("imagenArchivoAgregar");

          if (
            !producto ||
            !programa ||
            ingresos === "" ||
            parseFloat(ingresos) < 0
          ) {
            mostrarMensaje("Complete todos los campos obligatorios.", "error");
            return;
          }

          showLoading(true);
          const productData = {
            productoAgregar: producto,
            programaAgregar: programa,
            ingresosAgregar: parseFloat(ingresos),
          };

          const onSuccess = () => {
            closeAllModals();
            loadInventario();
          };

          if (imagenInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const fileData = {
                base64Data: event.target.result.split(",")[1],
                mimeType: imagenInput.files[0].type,
                fileName: imagenInput.files[0].name,
              };
              google.script.run
                .withSuccessHandler((res) =>
                  handleServerResponse(res, closeAllModals, loadInventario)
                )
                .withFailureHandler(handleServerError)
                .agregarProductoConImagenDesdeArchivo(productData, fileData);
            };
            reader.readAsDataURL(imagenInput.files[0]);
          } else {
            google.script.run
              .withSuccessHandler((res) =>
                handleServerResponse(res, closeAllModals, loadInventario)
              )
              .withFailureHandler(handleServerError)
              .agregarProductoInventario({ ...productData, imagenAgregar: "" });
          }
        });

      // ===========================
      // FORMULARIO: EDITAR
      // ===========================
      document
        .getElementById("editarForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const id = pageState.productoAEditarId;
          const producto = document
            .getElementById("productoEditar")
            .value.trim();
          const programa = document
            .getElementById("programaEditar")
            .value.trim();
          const ingresos = document.getElementById(
            "unidadesAgregarEditar"
          ).value;
          const imagen = document.getElementById("imagenEditar").value.trim();

          if (
            !producto ||
            !programa ||
            ingresos === "" ||
            parseFloat(ingresos) < 0
          ) {
            mostrarMensaje("Complete todos los campos obligatorios.", "error");
            return;
          }

          const productData = {
            idEditar: id,
            productoEditar: producto,
            programaEditar: programa,
            ingresosEditar: parseFloat(ingresos),
            imagenEditar: imagen,
          };

          showLoading(true);
          const onSuccess = () => {
            closeAllModals();
            loadInventario();
          };

          google.script.run
            .withSuccessHandler((res) =>
              handleServerResponse(res, closeAllModals, loadInventario)
            )
            .withFailureHandler(handleServerError)
            .actualizarProductoInventario(productData);
        });

      // ===========================
      // FORMULARIO: RETIRO
      // ===========================
      document
        .getElementById("retiroForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          // Asegurarnos de que productoRetiroSeleccionado es el objeto que guardamos al abrir el modal
          const selec = pageState.productoRetiroSeleccionado || {};
          const id = selec.id || selec; // si por alguna raz√≥n qued√≥ el id directo, lo acepta tambi√©n
          const unidades = parseInt(
            document.getElementById("unidadesRetirar").value,
            10
          );

          if (!id || isNaN(unidades) || unidades <= 0) {
            mostrarMensaje("Ingrese un n√∫mero v√°lido de unidades.", "error");
            return;
          }

          showLoading(true);
          const onSuccess = () => {
            closeAllModals();
            loadInventario();
          };

          google.script.run
            .withSuccessHandler((res) =>
              handleServerResponse(res, closeAllModals, loadInventario)
            )
            .withFailureHandler(handleServerError)
            .retirarProductoInventario(id, unidades);
        });

      // ===========================
      // FORMULARIO: COMENTARIO
      // ===========================
      document
        .getElementById("comentarioForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const comentario = document
            .getElementById("comentarioTexto")
            .value.trim();
          if (!comentario)
            return mostrarMensaje("El comentario no puede estar vac√≠o.", "error");

          const { id, producto } = pageState.productoComentarioSeleccionado;
          const usuario = currentUser ? currentUser.name : "Desconocido";

          registrarComentarioGenerico({
            sheetName: "Inventario articulos", // Nombre de la hoja de c√°lculo
            productoId: id,
            producto: producto,
            comentario: comentario,
            usuario: usuario,
            reloadFn: cargarNotificacionesDeComentariosArticulos, // Pasamos la funci√≥n de recarga
          });
          cerrarModalComentario();
        });
    })();

    // =================================================
    // --- 7. FUNCIONES DE UTILIDAD (HELPERS) ---
    // =================================================
    function confirmarEliminar(id, nombreProducto) {
      if (confirm(`¬øSeguro que deseas desactivar "${nombreProducto}"?`)) {
        showLoading(true);
        google.script.run
          .withSuccessHandler((res) =>
            handleServerResponse(res, null, loadInventario)
          )
          .withFailureHandler(handleServerError)
          .eliminarProductoInventario(id);
      }
    }

    function abrirImagenNuevaVentana(imageUrl) {
      if (imageUrl) window.open(imageUrl, "_blank");
    }

    function convertDaysToMonths(days) {
      return typeof days === "number" && days >= 0
        ? Math.floor(days / 30.44)
        : 0;
    }

    // =================================================
    // --- 8. L√ìGICA DE NOTIFICACIONES DE COMENTARIOS ---
    // =================================================

    /**
     * @summary Carga las notificaciones de comentarios pendientes y le√≠das desde el backend.
     * Tambi√©n actualiza el contador de notificaciones en el bot√≥n principal.
     */
    function cargarNotificacionesDeComentariosArticulos() {
        showLoading(true);
        const origen = "Inventario articulos"; // Origen espec√≠fico para esta p√°gina

        Promise.all([
            new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => resolve(JSON.parse(response)))
                    .withFailureHandler(reject)
                    .getNotificacionesPendientesUsuario(origen);
            }),
            new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(response => resolve(JSON.parse(response)))
                    .withFailureHandler(reject)
                    .getNotificacionesLeidasUsuario(origen);
            })
        ]).then(([pendientesResult, leidasResult]) => {
            hideLoading();
            if (pendientesResult.error || leidasResult.error) {
                mostrarMensaje("Error al cargar notificaciones: " + (pendientesResult.error || leidasResult.error), "error");
                return;
            }
            renderNotificacionesPendientesArticulos(pendientesResult.data || []);
            renderNotificacionesLeidasArticulos(leidasResult.data || []);
            
            const count = (pendientesResult.data || []).length;
            const notifCountEl = document.getElementById('notificacionCantidadComentarios');
            if (notifCountEl) {
                notifCountEl.textContent = count;
                notifCountEl.style.display = count > 0 ? 'inline-block' : 'none';
            }

        }).catch(error => {
            hideLoading();
            console.error("Error fatal al cargar notificaciones de comentarios:", error);
            mostrarMensaje("Error de conexi√≥n al cargar notificaciones.", "error");
        });
    }

    /**
     * @summary Renderiza la tabla de notificaciones pendientes.
     * @param {Array<Object>} data - Array de notificaciones pendientes.
     */
    function renderNotificacionesPendientesArticulos(data) {
        const tbody = document.getElementById('tablaComentariosPendientesBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No tienes respuestas pendientes.</td></tr>';
            return;
        }
        data.forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${escapeHtml(item.Producto)}</td>
                <td>${escapeHtml(item.Comentario)}</td>
                <td>${escapeHtml(item.Respuesta)}</td>
                <td>
                    <button class="btn-confirmar" onclick="confirmarLecturaNotificacionArticulos(${item.Id})">
                        <ion-icon name="checkmark-done-outline"></ion-icon> Confirmar
                    </button>
                </td>
            `;
        });
    }

    /**
     * @summary Renderiza la tabla de notificaciones le√≠das.
     * @param {Array<Object>} data - Array de notificaciones le√≠das.
     */
    function renderNotificacionesLeidasArticulos(data) {
        const tbody = document.getElementById('tablaComentariosLeidasBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No tienes notificaciones le√≠das.</td></tr>';
            return;
        }
        data.forEach(item => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${escapeHtml(item.Producto)}</td>
                <td>${escapeHtml(item.Comentario)}</td>
                <td>${escapeHtml(item.Respuesta)}</td>
                <td>
                    <button class="btn-eliminar" onclick="borrarNotificacionUsuarioArticulos(${item.Id})">
                        <ion-icon name="trash-outline"></ion-icon> Borrar
                    </button>
                </td>
            `;
        });
    }

    /**
     * @summary Maneja el clic en el bot√≥n 'Confirmar' de una notificaci√≥n.
     * @param {number} comentarioId - El ID del comentario a confirmar.
     */
    function confirmarLecturaNotificacionArticulos(comentarioId) {
        showLoading(true);
        google.script.run
            .withSuccessHandler(response => {
                const result = JSON.parse(response);
                hideLoading();
                if (result.success) {
                    mostrarMensaje("Notificaci√≥n movida a le√≠das.", "success");
                    cargarNotificacionesDeComentariosArticulos(); // Recargar ambas pesta√±as
                } else {
                    mostrarMensaje("Error: " + result.message, "error");
                }
            })
            .withFailureHandler(handleServerError)
            .confirmarRespuesta(comentarioId);
    }

    /**
     * @summary Maneja el clic en el bot√≥n 'Borrar' de una notificaci√≥n le√≠da.
     * @param {number} comentarioId - El ID del comentario a borrar.
     */
    function borrarNotificacionUsuarioArticulos(comentarioId) {
        if (!confirm("¬øEst√°s seguro de que quieres borrar esta notificaci√≥n? No podr√°s verla de nuevo.")) {
            return;
        }
        showLoading(true);
        google.script.run
            .withSuccessHandler(response => {
                const result = JSON.parse(response);
                hideLoading();
                if (result.success) {
                    mostrarMensaje("Notificaci√≥n borrada.", "success");
                    cargarNotificacionesDeComentariosArticulos(); // Recargar para que desaparezca
                } else {
                    mostrarMensaje("Error: " + result.message, "error");
                }
            })
            .withFailureHandler(handleServerError)
            .marcarComentarioBorradoUsuario(comentarioId);
    }
    
    /**
     * @summary Configura los listeners para las pesta√±as del modal de notificaciones.
     */
    function setupNotificacionTabsArticulos() {
        const tabContainer = document.querySelector('#modalNotificacion-Comentario .tab-buttons-container');
        if (!tabContainer) return;

        // Prevenir m√∫ltiples listeners
        if (tabContainer.dataset.listenerAttached) return;
        tabContainer.dataset.listenerAttached = 'true';

        tabContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.tab-button');
            if (button) {
                const tabId = button.dataset.tab;
                
                document.querySelectorAll('#modalNotificacion-Comentario .tab-content').forEach(content => {
                    content.classList.remove('active');
                    content.style.display = 'none';
                });

                document.querySelectorAll('#modalNotificacion-Comentario .tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                const activeContent = document.getElementById(tabId);
                if (activeContent) {
                    activeContent.classList.add('active');
                    activeContent.style.display = 'block';
                }
                button.classList.add('active');
            }
        });
    }

    // ===============================================
    // --- 9. INICIALIZACI√ìN Y EXPOSICI√ìN GLOBAL ---
    // ===============================================
    function inicializarPaginaArticulos() {
      const setupListener = (id, event, handler) =>
        document.getElementById(id)?.addEventListener(event, handler);
      setupListener("buscarProducto", "input", aplicarFiltrosYOrdenar);
      setupListener("filtroPrograma", "input", aplicarFiltrosYOrdenar);
      setupListener("filtroFechaIngreso", "change", aplicarFiltrosYOrdenar);
      setupListener("filtroUnidades", "input", aplicarFiltrosYOrdenar);
      setupListener("filtroTiempoStorage", "input", aplicarFiltrosYOrdenar);
      setupListener("filtroEstado", "change", aplicarFiltrosYOrdenar);

      const toggleBtn = document.getElementById("toggleFiltrosIconContainer");
      if (toggleBtn) {
        document
          .getElementById("filtrosAdicionalesContainer")
          .classList.add("filtros-adicionales-ocultos");
        toggleBtn.addEventListener("click", () =>
          toggleFiltrosAdicionalesGenerico("filtrosAdicionalesContainer")
        );
      }

      document.getElementById("filtroEstado").value = "activo";
      setupNotificacionTabsArticulos();
      loadInventario();
      cargarNotificacionesDeComentariosArticulos();
    }

    registrarEscapeCierraModales([
      cerrarModalAgregar,
      cerrarModalEditar,
      cerrarModalRetiro,
      cerrarModalComentario,
      cerrarModalNotificaciones,
      cerrarModalNotificacionComentario,
    ]);

    // Exponer funciones al scope global
    Object.assign(window, {
      abrirModalAgregar,
      cerrarModalAgregar,
      abrirModalRetiro,
      cerrarModalRetiro,
      abrirModalEditar,
      cerrarModalEditar,
      abrirModalComentario,
      cerrarModalComentario,
      abrirModalNotificacionesInterno,
      cerrarModalNotificaciones,
      abrirImagenNuevaVentana,
      confirmarEliminar,
      handleIndividualCheckboxChange,
      deactivateSelectedNotifications,
      clearNotifications,
      limpiarTodosLosFiltros: () =>
        limpiarFiltrosGenerico({
          filtros: [
            { id: "buscarProducto", type: "text" },
            { id: "filtroPrograma", type: "text" },
            { id: "filtroFechaIngreso", type: "date" },
            { id: "filtroUnidades", type: "number" },
            { id: "filtroTiempoStorage", type: "number" },
            { id: "filtroEstado", type: "select", defaultValue: "activo" },
          ],
          aplicarFn: aplicarFiltrosYOrdenarArticulos,
        }),
      ordenarPorFecha: (e) => ordenarPorFechaGenerico(e, "sortOptions"),
      ordenarAscendente: () =>
        ordenarAscendenteGenerico(
          aplicarFiltrosYOrdenar,
          "sortOptions",
          (val) => (pageState.fechaOrdenAscendente = val)
        ),
      ordenarDescendente: () =>
        ordenarDescendenteGenerico(
          aplicarFiltrosYOrdenar,
          "sortOptions",
          (val) => (pageState.fechaOrdenAscendente = val)
        ),
      abrirModalNotificacionComentario,
      cerrarModalNotificacionComentario,
      cargarNotificacionesDeComentariosArticulos,
      confirmarLecturaNotificacionArticulos,
      borrarNotificacionUsuarioArticulos,
    });

    inicializarPaginaArticulos();
  })();
</script>
