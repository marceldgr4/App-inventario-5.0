<script>
// =================================================================
// --- VARIABLES GLOBALES PARA LA PÁGINA DE REGISTRO DE USUARIOS ---
// =================================================================
let fullRegistroData = []; // Almacena todos los registros de acciones de usuario.
let currentRegistroPage = 1; // Página actual de la tabla de registro.
let registroItemsPerPage = 10; // Ítems a mostrar por página.
let fechaOrdenAscendenteRegistro = false; // Controla la dirección del ordenamiento por fecha.


// ===================================
// --- FUNCIONES DE FEEDBACK DE UI ---
// ===================================

/**
 * @summary Muestra un mensaje de feedback en la página de registro.
 * @param {string} mensaje - El texto a mostrar.
 */
function mostrarMensajeRegistro(mensaje) {
  const mensajeDiv = document.getElementById('mensajeConfirmacionRegistro');
  mensajeDiv.querySelector('span').textContent = mensaje;
  mensajeDiv.style.display = 'block';
}

function cerrarMensajeRegistro() {
  document.getElementById('mensajeConfirmacionRegistro').style.display = 'none';
}
/**
 * @summary Muestra la superposición de carga para la sección de registro.
 */
function showLoadingRegistro() {
  document.getElementById('loadingOverlayRegistro').style.display = 'block';
}
/**
 * @summary Oculta la superposición de carga de la sección de registro.
 */
function hideLoadingRegistro() {
  document.getElementById('loadingOverlayRegistro').style.display = 'none';
}
// ===================================
// --- CARGA Y RENDERIZADO DE DATOS ---
// ===================================

/**
 * @summary Carga todos los registros de acciones de usuario desde el servidor.
 * @description Llama a la función `getRegistroData` en el servidor. Al recibir los datos,
 * los almacena, los ordena por fecha descendente (más recientes primero) y renderiza la tabla.
 */

function loadRegistro() {
  console.log('Iniciando loadRegistro');
  showLoadingRegistro();
  google.script.run
    .withSuccessHandler(function (json) {
      hideLoadingRegistro();
      try {
        const response = JSON.parse(json);
        if (response && response.data) {
          fullRegistroData = response.data;
          fullRegistroData.sort((a, b) => {
            const fechaA = new Date(a['Fecha']);
            const fechaB = new Date(b['Fecha']);
            return fechaB - fechaA;
          });
          renderRegistroPaginatedTable(fullRegistroData);
        } else {
          console.error('Error loading history: invalid response');
          document.getElementById('tablaRegistroBody').innerHTML =
            "<tr><td colspan='10'>Error al cargar el Registro.</td></tr>";
        }
      } catch (e) {
        console.error('Error parsing history response:', e);
        document.getElementById('tablaRegistroBody').innerHTML =
          "<tr><td colspan='10'>Error al procesar los datos del Registro.</td></tr>";
      }
    })
    .withFailureHandler(function (error) {
      hideLoadingRegistro();
      console.error('Error getting history data:', error);
      mostrarMensajeRegistro('Error al cargar el Registro.');
    })
    .getRegistroData(); // Make sure this function exists in your Apps Script
  console.log('Finalizando loadRegistro');
}
/**
 * @summary Renderiza una página específica de la tabla de registros de usuario.
 * @param {Array<object>} data - El conjunto de datos (completo o filtrado) a paginar y renderizar.
 */
function renderRegistroPaginatedTable(data) {
  const start = (currentRegistroPage - 1) * registroItemsPerPage;
  const paginatedItems = data.slice(start, start + registroItemsPerPage);
  generateRegistroTable(paginatedItems);
  renderRegistroPaginationControls(data.length);
}

/**
 * @summary Construye y muestra las filas de la tabla de registros en el DOM.
 * @param {Array<object>} items - Un arreglo de objetos de registro para mostrar en la página actual.
 */
function generateRegistroTable(items) {
  const tbody = document.getElementById('tablaRegistroBody');
  tbody.innerHTML = '';

  if (items.length === 0) {
    tbody.innerHTML =
      "<tr><td colspan='10'>No hay modificaciones en el Registro.</td></tr>";
    return;
  }

  items.forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
       <td>${item['Id']}</td>
       <td>${formatDate(item['Fecha'])}</td>
       <td>${item['User Name']}</td>
       <td>${item['Registro']}</td>
             `;
    tbody.appendChild(row);
  });
}

// ===================================
// --- ORDENAMIENTO Y BÚSQUEDA ---
// ===================================

/**
 * @summary Muestra/oculta el menú desplegable para ordenar por fecha.
 * @param {Event} event - El objeto de evento del clic.
 */
function ordenarPorFechaRegistro(event) {
  event.stopPropagation();
  document.getElementById('sortOptions').classList.toggle('show');
}
/**
 * @summary Ordena los datos de los registros por fecha en orden ascendente y renderiza la tabla.
 */
function ordenarAscendenteRegistro() {
  fullRegistroData.sort((a, b) => {
    const fechaA = new Date(a['Fecha']);
    const fechaB = new Date(b['Fecha']);
    return fechaA.getTime() - fechaB.getTime();
  });
  fechaOrdenAscendenteRegistro = true;
  renderRegistroPaginatedTable(fullRegistroData);
  updateActiveRegistroPage();
  document.getElementById('sortOptions').classList.remove('show');
}

function ordenarDescendenteRegistro() {
  fullRegistroData.sort((a, b) => {
    const fechaA = new Date(a['Fecha']);
    const fechaB = new Date(b['Fecha']);
    return fechaB.getTime() - fechaA.getTime();
  });
  fechaOrdenAscendenteRegistro = false;
  renderRegistroPaginatedTable(fullRegistroData);
  updateActiveRegistroPage();
  document.getElementById('sortOptions').classList.remove('show');
}
/**
 * @summary Filtra la tabla de registros según el texto introducido en el campo de búsqueda.
 * @description Busca coincidencias en las columnas de Fecha y User Name.
 */
function buscarPorNombreRegistro() {
  const query = document.getElementById('buscarRegistro').value.toLowerCase();
  const resultado = fullRegistroData.filter(
    item =>
      (item['Fecha'] && item['Fecha'].toLowerCase().includes(query)) ||
      (item['User Name'] && item['User Name'].toLowerCase().includes(query))
    //(item["Usuario"] && item["Usuario"].toLowerCase().includes(query))
  );
  currentRegistroPage = 1;
  renderRegistroPaginatedTable(resultado);
}
// ===================================
// --- PAGINACIÓN ---
// ===================================

/**
 * @summary Crea y renderiza los controles de paginación para la tabla de registros.
 * @param {number} totalItems - El número total de ítems para calcular el número de páginas.
 */
function renderRegistroPaginationControls(totalItems) {
  const totalPages = Math.ceil(totalItems / registroItemsPerPage);
  let controlsHTML = '';
  let maxButtons = 5;

  controlsHTML += `<button onclick="changeRegistroPage(currentRegistroPage - 1)" ${
    currentRegistroPage === 1 ? 'disabled' : ''
  }>Anterior</button>`;

  let startPage = 1;
  let endPage = totalPages;

  if (totalPages > maxButtons) {
    const halfButtons = Math.floor(maxButtons / 2);
    if (currentRegistroPage <= halfButtons) {
      endPage = maxButtons;
    } else if (currentRegistroPage >= totalPages - halfButtons) {
      startPage = totalPages - maxButtons + 1;
    } else {
      startPage = currentRegistroPage - halfButtons;
      endPage = currentRegistroPage + halfButtons;
    }
  }

  if (startPage > 1) {
    controlsHTML += `<span class="pagination-dots">...</span>`;
  }

  for (let i = startPage; i <= endPage; i++) {
    const activeClass = i === currentRegistroPage ? 'active' : '';
    controlsHTML += `<button class="${activeClass}" onclick="changeRegistroPage(${i})">${i}</button>`;
  }

  if (endPage < totalPages) {
    controlsHTML += `<span class="pagination-dots">...</span>`;
  }

  controlsHTML += `<button onclick="changeRegistroPage(currentRegistroPage + 1)" ${
    currentRegistroPage === totalPages ? 'disabled' : ''
  }>Siguiente</button>`;

  document.getElementById('registroPagination').innerHTML = controlsHTML;
  updateActiveRegistroPage();
}
/**
 * @summary Cambia la página actual de la tabla de registros y la vuelve a renderizar.
 * @param {number} page - El número de página al que se quiere ir.
 */

function changeRegistroPage(page) {
    const totalPages = Math.ceil(fullRegistroData.length / registroItemsPerPage);
    currentRegistroPage = Math.max(1, Math.min(page, totalPages || 1));
    renderRegistroPaginatedTable(fullRegistroData);
    updateActiveRegistroPage();
}

/**
 * @summary Actualiza el estilo del botón de la página activa en la paginación.
 */

function updateActiveRegistroPage() {
  const buttons = document.querySelectorAll('#RegistroPagination button');
  buttons.forEach(button => button.classList.remove('active'));
  const activeButton = document.querySelector(
    `#RegistroPagination button:nth-child(${
      currentRegistroPage + (currentRegistroPage > 5 ? 2 : 1)
    })`
  );
  if (activeButton) {
    activeButton.classList.add('active');
  }
}




// ===================================
// --- FUNCIONES DE UTILIDAD Y EVENTOS ---
// ===================================

/**
 * @summary Formatea una cadena de fecha a un formato 'dd/mm/yyyy'.
 * @param {string} dateString - La fecha a formatear.
 * @returns {string} La fecha formateada.
 */
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Fecha Inválida';
    return date.toLocaleDateString('es-CO');
}

/**
 * @summary Función de ejemplo o deprecada que parece intentar obtener datos del historial.
 * @description NOTA: Esta función parece estar incompleta o ser un remanente de código,
 * ya que llama a funciones del cliente y del servidor que no están definidas.
 */
function getHistoryData() {
  google.script.run
    .withSuccessHandler(renderHistoryTable)
    .getHistoryDataFromServer(); 
}

/**
 * Cierra el menú desplegable de ordenamiento si se hace clic fuera de él.
 */
window.onclick = function (event) {
  if (!event.target.matches('.sort-menu-icon')) {
    const dropdowns = document.getElementsByClassName('sort-options');
    for (let i = 0; i < dropdowns.length; i++) {
      const openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
};

/**
 * Carga inicial de los registros cuando la ventana ha terminado de cargar.
 */
window.onload = loadRegistro;

  </script>