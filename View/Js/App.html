<script>
  document.addEventListener("DOMContentLoaded", () => {
    const App = {
      elements: {
        sidebar: document.getElementById("sidebar"),
        mainContent: document.getElementById("main-content"),
        menu: document.getElementById("menu"),
        logoutLink: document.getElementById("logoutLink"),
        toggleBtn: document.getElementById("toggleSidebarBtn"),
        loadingOverlay: document.getElementById("loadingOverlay"),
      },

      state: {
        currentPage: "Home",
        pageCache: {},
      },

      init() {
        this.setupEventListeners();
        this.buildMenu();
        this.handleInitialPageLoad();
      },

      setupEventListeners() {
        this.elements.toggleBtn?.addEventListener("click", () => {
          this.elements.sidebar?.classList.toggle("collapsed");
        });

        this.elements.logoutLink?.addEventListener("click", (e) => {
          e.preventDefault();
          this.elements.logoutLink.innerHTML =
            '<span class="icon"><ion-icon name="hourglass-outline"></ion-icon></span><span class="title">Cerrando...</span>';
          google.script.run
            .withSuccessHandler((url) => {
              window.top.location.href = url;
            })
            .logout();
        });

        window.addEventListener("popstate", (e) => {
          const page = e.state?.page || "Home";
          this.loadPageContent(page, false);
        });
      },

      showLoading(show) {
        if (!this.elements.loadingOverlay) return;
        this.elements.loadingOverlay.style.display = show ? "flex" : "none";
        this.elements.loadingOverlay.style.opacity = show ? "1" : "0";
      },

      buildMenu() {
        const paginas = window.paginasDisponiblesParaUsuario || [];
        if (!Array.isArray(paginas)) {
          console.error("Menu data is not an array:", paginas);
          return;
        }

        const iconos = {
          Home: "home-outline",
          Dashboard: "bar-chart-outline",
          Art√≠culos: "cube-outline",
          Comida: "fast-food-outline",
          Decoraci√≥n: "color-palette-outline",
          Papeler√≠a: "document-text-outline",
          Acta: "document-attach-outline",
          Perfil: "person-circle-outline",
          Usuario: "people-outline",
          Historial: "time-outline",
          Registro: "clipboard-outline",
        };

        const baseUrl = "<?= getScriptUrl() ?>";

        paginas.forEach((page) => {
          if (page === "Login") return;

          const menuItem = document.createElement("a");
          menuItem.className = "menu-item";
          menuItem.href = `${baseUrl}?page=${page}`;
          menuItem.dataset.page = page;

          const iconName = iconos[page] || "document-outline";
          menuItem.innerHTML = `
            <span class="icon"><ion-icon name="${iconName}"></ion-icon></span>
            <span class="title">${page}</span>
          `;

          menuItem.addEventListener("click", (e) => {
            e.preventDefault();
            this.navigateTo(page);
          });

          this.elements.menu.appendChild(menuItem);
        });
      },

      navigateTo(pageName) {
        if (this.state.currentPage !== pageName) {
          history.pushState({ page: pageName }, "", `?page=${pageName}`);
          this.loadPageContent(pageName);
        }
      },

      loadPageContent(pageName, pushState = true) {
        this.state.currentPage = pageName;
        this.updateActiveMenuItem(pageName);
        this.showLoading(true);

        const renderPage = (html) => {
          this.elements.mainContent.innerHTML = html;

          // Re-ejecutar scripts internos
          Array.from(this.elements.mainContent.querySelectorAll("script")).forEach((oldScript) => {
            const newScript = document.createElement("script");
            Array.from(oldScript.attributes).forEach((attr) =>
              newScript.setAttribute(attr.name, attr.value)
            );
            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
            document.body.appendChild(newScript).parentNode.removeChild(newScript);
          });

          // --- CONTROL DE LOADER ---
          const simplePages = ["Home", "Perfil"];
          if (simplePages.includes(pageName)) {
            setTimeout(() => this.showLoading(false), 100);
          } else {
            // üîπ Oculta autom√°ticamente si el dashboard no lo hace por s√≠ mismo
            setTimeout(() => {
              this.showLoading(false);
              console.log(`‚úÖ Loader ocultado autom√°ticamente tras cargar '${pageName}'.`);
            }, 1000);
          }
        };

        if (this.state.pageCache[pageName]) {
          console.log(`Cargando '${pageName}' desde cach√©.`);
          renderPage(this.state.pageCache[pageName]);
        } else {
          console.log(`Cargando '${pageName}' desde el servidor.`);
          google.script.run
            .withSuccessHandler((htmlContent) => {
              this.state.pageCache[pageName] = htmlContent;
              renderPage(htmlContent);
            })
            .withFailureHandler((err) => {
              this.elements.mainContent.innerHTML = `
                <div style="padding:20px; color:red;">
                  <h2>Error al Cargar</h2><p>${err.message}</p>
                </div>`;
              this.showLoading(false);
            })
            .loadContent(pageName);
        }
      },

      handleInitialPageLoad() {
        const urlParams = new URLSearchParams(window.location.search);
        const initialPage = urlParams.get("page") || "Home";
        this.loadPageContent(initialPage, false);
      },

      updateActiveMenuItem(pageName) {
        const menuItems = this.elements.menu.querySelectorAll(".menu-item");
        menuItems.forEach((item) => {
          item.classList.toggle("active", item.dataset.page === pageName);
        });
      },
    };

    App.init();

    // üîî Escucha mensajes de subp√°ginas (como Dashboard) para ocultar loader sin error CORS
    window.addEventListener("message", (event) => {
      if (event.data?.type === "HIDE_LOADER") {
        const loader = document.getElementById("loadingOverlay");
        if (loader) {
          loader.style.transition = "opacity 0.5s ease";
          loader.style.opacity = "0";
          setTimeout(() => (loader.style.display = "none"), 500);
          console.log("‚úÖ Loader ocultado tras mensaje del Dashboard.");
        }
      }
    });
  });
</script>
