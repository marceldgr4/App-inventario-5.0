<script>
  /**
   * Js_Comida.html
   * @summary Lógica del cliente para la sección de Comida.
   * @description Este script maneja la carga de datos, renderizado de la tabla, paginación,
   * filtros, modales (agregar, editar, retirar, comentar) y notificaciones de vencimiento
   * para los productos de la categoría "Comida". Utiliza funciones de Js_Generico.html para
   * reducir la duplicación de código.
   */
  (function () {
    const pageStateComida = {
      fullData: [],
      datosMostrados: [],
      productosProximosAVencer: [],
      currentPage: 1,
      itemsPerPage: 10,
      productoAEditarId: null,
      productoRetiroSeleccionado: null,
      productoComentarioSeleccionado: null,
      fechaOrdenAscendente: false,
      criterioDeOrden: "id",
    };

    console.log("[INFO] Js_Comida cargado.");

    // =================================================
    // --- 1. CARGA DE DATOS Y NOTIFICACIONES ---
    // =================================================

    function loadComida() {
      loadDataGenerico({
        endpoint: "getComidaData",
        tbodyId: "tablaComidaBody",
        noDataId: "noData",
        containerId: "comidaContent",
        onSuccess: (data) => {
          pageStateComida.fullData = data || [];
          pageStateComida.currentPage = 1;
          aplicarFiltrosYOrdenarComida();
          // Las funciones genéricas ya manejan la visibilidad de 'noData' y la tabla.
          loadNotificacionesComida();
        },
      });
    }

    function loadNotificacionesComida() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (productosServer) {
          if (Array.isArray(productosServer)) {
            pageStateComida.productosProximosAVencer = productosServer.map(
              (p) => {
                let dias;
                if (typeof p.diasRestantes === "string") {
                  if (p.diasRestantes.toLowerCase().includes("vencido")) {
                    const match = p.diasRestantes.match(/-?\d+/);
                    dias = match ? -parseInt(match[0]) : -1;
                  } else if (p.diasRestantes.toLowerCase().includes("hoy")) {
                    dias = 0;
                  } else if (p.diasRestantes === "Sin fecha de vencimiento") {
                    dias = "Sin fecha de vencimiento";
                  } else {
                    const match = p.diasRestantes.match(/\d+/);
                    dias = match ? parseInt(match[0]) : "Error";
                  }
                } else if (typeof p.diasRestantes === "number") {
                  dias = p.diasRestantes;
                } else {
                  dias = "Error";
                }
                return {
                  id: p["Id"] || p.id || "N/A",
                  producto: p["PRODUCTO"] || p.producto || "N/A",
                  estado:
                    p["ESTADO DEL PRODUCTO"] ||
                    p.estadoProducto ||
                    p.estado ||
                    "N/A",
                  diasRestantes: dias,
                  ubicacion: p["UBICACION"] || p.ubicacion || "N/A",
                  unidadesDisponibles:
                    p["UNIDADES DISPONIBLES"] ??
                    p.unidades ??
                    p.unidadesDisponibles ??
                    "N/A",
                };
              }
            );
            mostrarNotificaciones();
          } else {
            pageStateComida.productosProximosAVencer = [];
            mostrarNotificaciones();
          }
          hideLoading();
        })
        .withFailureHandler(function (error) {
          console.error("Error al obtener productos próximos a vencer:", error);
          pageStateComida.productosProximosAVencer = [];
          mostrarNotificaciones();
        })
        .getProductosProximosAVencerCompleto("Inventario comida");
    }
    //=========
    //=== 2. RENDERIZADO DE TABLA Y PAGINACIÓN
    //=========
    function renderPaginatedTable() {
      renderPaginatedTableGeneric({
        data: pageStateComida.datosMostrados,
        currentPage: pageStateComida.currentPage,
        itemsPerPage: pageStateComida.itemsPerPage,
        tbodyId: "tablaComidaBody", // Asegúrate de que este ID coincida con tu HTML
        paginationContainerId: "comidaPagination", // Corregido para coincidir con el HTML
        noDataMessage: "No hay productos que coincidan con los filtros.",

        // LÓGICA ÚNICA DE COMIDA: Coloreado de filas y datasets
        onRowCreated: (row, item) => {
          const id = item.Id || item.ID || item.id || "";
          const ingresos =
            parseInt(item["Ingresos"] ?? item["INGRESOS"] ?? item.ingresos) ||
            0;
          const salidas =
            parseInt(item["Salidas"] ?? item["SALIDAS"] ?? item.salidas) || 0;
          const unidades =
            item["Unidades disponibles"] != null
              ? parseInt(item["Unidades disponibles"]) || 0
              : ingresos - salidas;

          // --- Colorear fila según vencimiento (LÓGICA ÚNICA DE COMIDA) ---
          const fechaVencimientoStr = item["FECHA DE VENCIMIENTO"];
          const currentDate = new Date();
          currentDate.setHours(0, 0, 0, 0);
          const oneMonthLater = new Date(currentDate);
          oneMonthLater.setMonth(currentDate.getMonth() + 1);

          if (fechaVencimientoStr) {
            // formatDateForComparison debe existir en Js_Generico.html
            const fechaVencimientoDate = new Date(
              formatDateForComparison(fechaVencimientoStr)
            );
            if (!isNaN(fechaVencimientoDate.getTime())) {
              fechaVencimientoDate.setHours(0, 0, 0, 0);
              if (fechaVencimientoDate < currentDate)
                row.classList.add("vencido");
              else if (fechaVencimientoDate.getTime() === currentDate.getTime())
                row.classList.add("vencido-hoy");
              else if (fechaVencimientoDate < oneMonthLater)
                row.classList.add("proximo-a-vencer");
            }
          }

          // --- Dataset para eventos ---
          row.dataset.id = String(id || "");
          row.dataset.producto = item["PRODUCTO"] || "";
          row.dataset.unidades = unidades;
        },

        // LÓGICA ÚNICA DE COMIDA: Contenido de la fila
        renderRow: (item) => {
          const ingresos = parseInt(item["Ingresos"]) || 0;
          const salidas = parseInt(item["Salidas"]) || 0;
          const unidades =
            item["Unidades disponibles"] != null
              ? parseInt(item["Unidades disponibles"]) || 0
              : ingresos - salidas;
          const id = item.Id || item.ID || item.id || "";
          const agotadoClass = unidades === 0 ? "agotado" : "";

          // --- Formato de precio (LÓGICA ÚNICA DE COMIDA) ---
          let precioFormateado = "$ 0,00";
          if (item["PRECIO"] != null && !isNaN(parseFloat(item["PRECIO"]))) {
            // toLocaleString debe ser una función disponible (ej. en Js_Generico.html)
            precioFormateado = parseFloat(item["PRECIO"]).toLocaleString(
              "es-CO",
              { style: "currency", currency: "COP" }
            );
          }

          return `
                    <td>${id}</td>
                    <td>${item["PRODUCTO"] || ""}</td>
                    <td>${precioFormateado}</td>
                    <td>${item["UBICACION"] || ""}</td>
                    <td>${item["ESTADO DEL PRODUCTO"] || ""}</td>
                    <td>${formatDate(item["FECHA DE INGRESO"])}</td>
                    <td>${ingresos}</td>
                    <td>${salidas}</td>
                    <td class="${agotadoClass}">${unidades}</td>
                    <td>${formatDate(item["FECHA DE VENCIMIENTO"])}</td>
                    <td>${item["COMENTARIOS"] || ""}</td>
                    <td>
                        <button class="btn-modificar"><ion-icon name="create-outline"></ion-icon></button>
                        <button class="btn-retirar"><ion-icon name="bag-remove-outline"></ion-icon></button>
                        <button class="btn-comentario"><ion-icon name="chatbubbles-outline"></ion-icon></button>
                        <button class="btn-eliminar"><ion-icon name="trash-bin-outline"></ion-icon></button>
                    </td>
                `;
        },
        onPageChange: (page) => {
          pageStateComida.currentPage = page;
          renderPaginatedTable();
        },
      });
    }

    document
      .getElementById("tablaComidaBody")
      ?.addEventListener("click", (e) => {
        const row = e.target.closest("tr");
        if (!row) return;
        const id = row.dataset.id;
        const producto = row.dataset.producto;
        const unidades = parseInt(row.dataset.unidades) || 0;

        if (e.target.closest(".btn-modificar")) {
          abrirModalEditarComida(id);
        }
        if (e.target.closest(".btn-retirar")) {
          abrirModalRetiroComida(id, producto, unidades);
        }
        if (e.target.closest(".btn-comentario")) {
          abrirModalComentarioComida(id, producto);
        }
        if (e.target.closest(".btn-eliminar")) {
          confirmarEliminarComida(id, producto);
        }
      });

    // =================================================
    // --- 3. RENDERIZADO DE NOTIFICACIONES Y TABS ---
    // =================================================
    function mostrarNotificaciones() {
      console.log("[INFO] Mostrando notificaciones de comida...");
      const proximos = pageStateComida.productosProximosAVencer.filter(
        (p) => typeof p.diasRestantes === "number" && p.diasRestantes >= 0
      );
      const vencidos = pageStateComida.productosProximosAVencer.filter(
        (p) => typeof p.diasRestantes === "number" && p.diasRestantes < 0
      );

      // Ocultar pestaña "sin vencimiento" si existe
      const tabSinVencimientoButton = document.querySelector(
        'button[data-tab="sin-vencimiento"]'
      );
      if (tabSinVencimientoButton)
        tabSinVencimientoButton.style.display = "none";
      const tabSinVencimientoContent =
        document.getElementById("sin-vencimiento");
      if (tabSinVencimientoContent)
        tabSinVencimientoContent.style.display = "none";

      // Mostrar cantidad de notificaciones
      const cantidadEl = document.getElementById("notificacionCantidad");
      const itemsNotificables = pageStateComida.productosProximosAVencer.length;
      if (cantidadEl) {
        if (itemsNotificables > 0) {
          cantidadEl.style.display = "inline-block";
          cantidadEl.textContent = itemsNotificables.toString();
        } else {
          cantidadEl.style.display = "none";
        }
      }

      // Render de tablas
      mostrarTablaVencimiento(proximos, "tablaProximosVencimientoBody");
      mostrarTablaVencimiento(vencidos, "tablaVencidosBody");

      // Cambiar tab activo por lógica
      const tabProximosBtn = document.querySelector('[data-tab="proximos"]');
      const tabVencidosBtn = document.querySelector('[data-tab="vencidos"]');
      if (vencidos.length > 0 && proximos.length === 0) {
        mostrarTab("vencidos", tabVencidosBtn);
      } else {
        mostrarTab("proximos", tabProximosBtn);
      }
    }

    function mostrarTablaVencimiento(items, tablaBodyId) {
      const tbody = document.getElementById(tablaBodyId);
      if (!tbody) return;
      tbody.innerHTML = "";

      if (items.length === 0) {
        const message =
          tablaBodyId === "tablaProximosVencimientoBody"
            ? "No hay productos próximos a vencer."
            : "No hay productos vencidos.";
        tbody.innerHTML = `<tr><td colspan='7' style='text-align:center;'>${message}</td></tr>`;
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");

        let diasTexto =
          tablaBodyId === "tablaProximosVencimientoBody"
            ? item.diasRestantes === 0
              ? "Vence hoy"
              : `${item.diasRestantes} días`
            : `Hace ${Math.abs(item.diasRestantes)} días`;

        const id = item.Id || item.ID || item.id || "";
        const unidades = parseInt(item.unidadesDisponibles) || 0;
        const agotadoClass = unidades === 0 ? "agotado" : "";

        row.dataset.id = String(id || "");
        row.dataset.unidades = unidades;

        row.innerHTML = `
            <td>${id}</td>
            <td>${escapeHtml(item.producto || "N/A")}</td>
            <td>${diasTexto}</td>
            <td>${escapeHtml(item.estado || "N/A")}</td>
            <td>${escapeHtml(item.ubicacion || "N/A")}</td>
            <td class="${agotadoClass}">${unidades}</td>
            ${
              tablaBodyId === "tablaVencidosBody"
                ? `<td><input type="checkbox" class="notificacion-checkbox" value="${id}" onchange="handleIndividualCheckboxChange(this)"></td>`
                : ""
            }
        `;
        tbody.appendChild(row);
      });
    }

    function mostrarTab(tabId, boton) {
      document.querySelectorAll(".tab-content").forEach((tab) => {
        tab.classList.remove("active");
        tab.style.display = "none";
      });
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.classList.remove("active");
      });
      const tabActiva = document.getElementById(tabId);
      if (tabActiva) {
        tabActiva.classList.add("active");
        tabActiva.style.display = "block";
      }
      if (boton) boton.classList.add("active");
    }

    function limpiarNotificaciones() {
      pageStateComida.productosProximosAVencer = [];
      const cantidadEl = document.getElementById("notificacionCantidad");
      if (cantidadEl) {
        cantidadEl.style.display = "none";
        cantidadEl.textContent = "";
      }
      mostrarTablaVencimiento([], "tablaProximosVencimientoBody");
      mostrarTablaVencimiento([], "tablaVencidosBody");
      mostrarMensaje("Notificaciones de vencimiento limpiadas.", "success");
    }

    // Js_Comida.html - Modificación de la función existente

    function deactivateSelectedNotifications() {
      // Recoge los IDs de los checkboxes marcados
      const seleccionados = [
        ...document.querySelectorAll(".notificacion-checkbox:checked"),
      ].map((cb) => cb.value);

      if (seleccionados.length === 0) {
        mostrarMensaje(
          "Selecciona al menos un producto para desactivar.",
          "info"
        );
        return;
      }

      // El mensaje de confirmación indica el cambio de estado
      if (
        confirm(
          `¿Seguro que deseas desactivar ${seleccionados.length} producto(s) seleccionado(s)? (Cambiarán a 'Desactivado')`
        )
      ) {
        showLoading(true);

        const sheetName = "Inventario comida";
        google.script.run
          .withSuccessHandler(handleDeactivateSuccess)
          .withFailureHandler(handleDeactivateFailure)
          .deactivateProducts(seleccionados, sheetName);
      }
    }

    // Js_Comida.html - Modificación de la función existente

    function handleIndividualCheckboxChange() {
      const anyChecked =
        document.querySelectorAll(".notificacion-checkbox:checked").length > 0;
      // Se usa el ID del botón que se añadió en Comida.html
      const btn = document.getElementById("btnBorrarSeleccionadosVencimiento");
      if (btn) btn.disabled = !anyChecked;
    }
    // Js_Comida.html - Nuevas funciones de manejo

    function handleDeactivateSuccess(response) {
      showLoading(false);
      try {
        const result = JSON.parse(response);
        if (result.success) {
          mostrarMensaje(result.message, "success");
          loadComida(); // Recarga la tabla principal
          loadNotificacionesComida(); // Recarga el modal de notificaciones
        } else {
          mostrarMensaje(
            "Error al desactivar productos: " + result.message,
            "error"
          );
        }
      } catch (e) {
        mostrarMensaje(
          "Error de formato de respuesta o en la operación.",
          "error"
        );
        loadComida();
        loadNotificacionesComida();
      }
    }

    function handleDeactivateFailure(error) {
      showLoading(false);
      console.error("Error en la desactivación masiva:", error);
      mostrarMensaje(
        "Error al conectar con el servidor para desactivar: " + String(error),
        "error"
      );
    }

    function loadComentarios() {
      showLoading(true);
      google.script.run
        .withSuccessHandler(function (responseString) {
          showLoading(false);
          try {
            const response = JSON.parse(responseString);
            if (response.data) {
              renderComentarios(response.data);
            } else {
              console.error("No data in response:", response);
              mostrarMensaje("No se encontraron comentarios.", "info");
            }
          } catch (e) {
            console.error("Error parsing comments response:", e);
            mostrarMensaje(
              "Error al procesar la respuesta de comentarios.",
              "error"
            );
          }
        })
        .withFailureHandler(function (error) {
          showLoading(false);
          console.error("Error loading comments:", error);
          mostrarMensaje("Error al cargar los comentarios.", "error");
        })
        .getComentarioData();
    }

    function renderComentarios(comentarios) {
      const pendientesBody = document.getElementById(
        "tablaComentariosPendientesBody"
      );
      const leidasBody = document.getElementById("tablaComentariosLeidasBody");

      if (!pendientesBody || !leidasBody) {
        console.error("[ERROR] Elementos de comentarios no encontrados");
        return;
      }

      pendientesBody.innerHTML = "";
      leidasBody.innerHTML = "";

      const pendientes = comentarios.filter((c) => !c.Leido);
      const leidas = comentarios.filter((c) => c.Leido);

      if (pendientes.length === 0) {
        pendientesBody.innerHTML =
          "<tr><td colspan='4'>No hay comentarios pendientes.</td></tr>";
      } else {
        pendientes.forEach((c) => {
          const row = pendientesBody.insertRow();
          row.innerHTML = `
                    <td>${escapeHtml(c.Id)}</td>
                    <td>${escapeHtml(c.Producto)}</td>
                    <td>${formatDate(c.Fecha)}</td>
                    <td>${escapeHtml(c.Comentario)}</td>
                `;
        });
      }

      if (leidas.length === 0) {
        leidasBody.innerHTML =
          "<tr><td colspan='4'>No hay comentarios leídos.</td></tr>";
      } else {
        leidas.forEach((c) => {
          const row = leidasBody.insertRow();
          row.innerHTML = `
                    <td>${escapeHtml(c.Id)}</td>
                    <td>${escapeHtml(c.Producto)}</td>
                    <td>${formatDate(c.Fecha)}</td>
                    <td>${escapeHtml(c.Comentario)}</td>
                `;
        });
      }
    }

    // =================================================
    // --- 4. MANEJO DE MODALES ---
    // =================================================
    function abrirModalAgregarComida() {
      abrirModal("modalAgregarComida");
      document.getElementById("agregarComidaForm").reset();
    }
    function cerrarModalAgregarComida() {
      cerrarModal("modalAgregarComida");
    }

    function abrirModalEditarComida(id) {
      const producto = pageStateComida.fullData.find(
        (p) => String(p.Id) === String(id)
      );
      if (!producto) return mostrarMensaje("Producto no encontrado", "error");

      pageStateComida.productoAEditarId = id;
      abrirModal("modalEditarComida");

      document.getElementById("productoIdEditarComida").textContent = id;
      document.getElementById("productoEditarComida").value =
        producto["PRODUCTO"] || "";
      document.getElementById("precioEditarComida").value =
        producto["PRECIO"] || "0";
      document.getElementById("unidadesAgregarEditarComida").value = "0";
      document.getElementById("ubicacionEditarComida").value =
        producto["UBICACION"] || "";
      document.getElementById("estadoEditarComida").value =
        producto["ESTADO DEL PRODUCTO"] || "";
      document.getElementById("fechaVencimientoEditarComida").value = producto[
        "FECHA DE VENCIMIENTO"
      ]
        ? new Date(producto["FECHA DE VENCIMIENTO"]).toISOString().split("T")[0]
        : "";
      document.getElementById("comentariosEditarComida").value =
        producto["COMENTARIOS"] || "";

      // Formatear precio al cargar
      formatearPrecio(document.getElementById("precioEditarComida"));
    }
    function cerrarModalEditarComida() {
      cerrarModal("modalEditarComida");
    }

    function abrirModalRetiroComida(id, producto, unidades) {
      pageStateComida.productoRetiroSeleccionado = {
        id,
        producto,
        unidadesDisponibles: unidades,
      };
      abrirModal("modalRetiroComida");
      document.getElementById("productoIdRetiroComida").textContent = id;
      document.getElementById("productoNombreRetiroComida").textContent =
        producto;
      document.getElementById("unidadesDisponiblesRetiroComida").textContent =
        unidades;
      document.getElementById("unidadesRetirarComida").max = unidades;
      document.getElementById("unidadesRetirarComida").value = "";
    }
    function cerrarModalRetiroComida() {
      cerrarModal("modalRetiroComida");
    }

    function abrirModalComentarioComida(id, producto) {
      const item = pageStateComida.fullData.find(
        (p) => String(p.Id) === String(id)
      );
      if (!item) return mostrarMensaje("Producto no encontrado", "error");
      pageStateComida.productoComentarioSeleccionado = {
        Id: id,
        producto: item["PRODUCTO"],
      };
      abrirModal("modalComentarioComida");
      document.getElementById("comentarioProductoIdComida").textContent = id;
      document.getElementById("comentarioProductoNombreComida").textContent =
        item["PRODUCTO"];
      document.getElementById("comentarioTextoComida").value = "";
    }
    function cerrarModalComentarioComida() {
      cerrarModal("modalComentarioComida");
    }

    function abrirModalVencimientoComida() {
      abrirModal("modalVencimiento-Comida");
      loadNotificacionesComida();
    }
    function cerrarModalVencimientoComida() {
      cerrarModal("modalVencimiento-Comida");
    }

    function abrirModalNotificacionComentarioComida() {
      abrirModal("modalNotificacion-Comentario");
      loadComentarios();
    }
    function cerrarModalNotificacionComentarioComida() {
      cerrarModal("modalNotificacion-Comentario");
    }

    // =================================================
    // --- 5. MANEJO DE FORMULARIOS ---
    // =================================================
    document
      .getElementById("agregarComidaForm")
      ?.addEventListener("submit", (e) => {
        e.preventDefault();
        if (
          !validarFormatoPrecio(document.getElementById("precioAgregarComida"))
        )
          return;
        showLoading(true);
        const data = {
          productoAgregar: document.getElementById("productoAgregarComida")
            .value,
          ingresosAgregar: parseFloat(
            document.getElementById("ingresosAgregarComida").value
          ),
          precioAgregar: convertirPrecioFormateadoAStringNumericoParaServidor(
            document.getElementById("precioAgregarComida").value
          ),
          ubicacionAgregar: document.getElementById("ubicacionAgregarComida")
            .value,
          estadoAgregar: document.getElementById("estadoAgregarComida").value,
          fechaVencimientoAgregar: document.getElementById(
            "fechaVencimientoAgregarComida"
          ).value,
          comentariosAgregar: document.getElementById(
            "comentariosAgregarComida"
          ).value,
        };
        google.script.run
          .withSuccessHandler((r) =>
            handleServerResponse(r, cerrarModalAgregarComida, loadComida)
          )
          .withFailureHandler(handleServerError)
          .agregarComida(data);
      });

    document
      .getElementById("editarComidaForm")
      ?.addEventListener("submit", (e) => {
        e.preventDefault();
        if (
          !validarFormatoPrecio(document.getElementById("precioEditarComida"))
        )
          return;
        showLoading(true);
        const data = {
          idEditar: pageStateComida.productoAEditarId,
          productoEditar: document.getElementById("productoEditarComida").value,
          precioEditar: convertirPrecioFormateadoAStringNumericoParaServidor(
            document.getElementById("precioEditarComida").value
          ),
          ingresosEditar:
            parseFloat(
              document.getElementById("unidadesAgregarEditarComida").value
            ) || 0,
          ubicacionEditar: document.getElementById("ubicacionEditarComida")
            .value,
          estadoEditar: document.getElementById("estadoEditarComida").value,
          fechaVencimientoEditar: document.getElementById(
            "fechaVencimientoEditarComida"
          ).value,
          comentariosEditar: document.getElementById("comentariosEditarComida")
            .value,
        };
        google.script.run
          .withSuccessHandler((r) =>
            handleServerResponse(r, cerrarModalEditarComida, loadComida)
          )
          .withFailureHandler(handleServerError)
          .actualizarComida(data);
      });

    document
      .getElementById("retiroComidaForm")
      ?.addEventListener("submit", (e) => {
        e.preventDefault();
        showLoading(true);
        const unidades = parseInt(
          document.getElementById("unidadesRetirarComida").value
        );
        const disponibles =
          pageStateComida.productoRetiroSeleccionado.unidadesDisponibles;
        if (isNaN(unidades) || unidades <= 0 || unidades > disponibles) {
          hideLoading();
          return mostrarMensaje(
            `Cantidad inválida. Debe ser un número entre 1 y ${disponibles}.`,
            "error"
          );
        }
        google.script.run
          .withSuccessHandler((r) =>
            handleServerResponse(r, cerrarModalRetiroComida, loadComida)
          )
          .withFailureHandler(handleServerError)
          .retirarComida(
            pageStateComida.productoRetiroSeleccionado.id,
            unidades
          );
      });

    document
      .getElementById("comentarioComidaForm")
      ?.addEventListener("submit", (e) => {
        e.preventDefault();
        const comentario = document
          .getElementById("comentarioTextoComida")
          .value.trim();
        if (!comentario)
          return mostrarMensaje("El comentario no puede estar vacío.", "error");

        const { Id, producto } = pageStateComida.productoComentarioSeleccionado;
        const usuario = currentUser ? currentUser.name : "Desconocido";

        registrarComentarioGenerico({
          sheetName: "Inventario comida", // Nombre de la hoja de cálculo
          productoId: Id,
          producto: producto,
          comentario: comentario,
          usuario: usuario,
          reloadFn: loadComentarios, // Pasamos la función de recarga
        });
        cerrarModalComentarioComida();
      });

    // =================================================
    // --- 6. FILTROS Y ORDENAMIENTO ---
    // =================================================
    function aplicarFiltrosYOrdenarComida() {
      if (typeof aplicarFiltrosYOrdenarGenerico === "function") {
        aplicarFiltrosYOrdenarGenerico({
          dataSource: pageStateComida.fullData,
          setResultados: (val) => {
            pageStateComida.datosMostrados = val;
            pageStateComida.currentPage = 1;
          },
          fechaOrdenAsc: pageStateComida.fechaOrdenAscendente,
          renderFn: renderPaginatedTable,
          filters: [
            { id: "buscarComida", field: "PRODUCTO", type: "text" },
            { id: "filtroUbicacionComida", field: "UBICACION", type: "text" },
            {
              id: "filtroEstadoProductoComida",
              field: "ESTADO DEL PRODUCTO",
              type: "text",
            },
            {
              id: "filtroUnidadesComida",
              field: "Unidades disponibles",
              type: "number",
            },
            { id: "filtroEstadoComidaSelect", field: "Estado", type: "text" },
          ],
        });
        return;
      }
      // Fallback si no existe la función genérica
      pageStateComida.datosMostrados = Array.isArray(pageStateComida.fullData)
        ? pageStateComida.fullData.slice()
        : [];
      renderPaginatedTable();
    }

    function limpiarTodosLosFiltrosComida() {
      if (typeof limpiarFiltrosGenerico === "function") {
        limpiarFiltrosGenerico({
          filtros: [
            { id: "buscarComida", type: "text" },
            { id: "filtroUbicacionComida", type: "text" },
            { id: "filtroEstadoProductoComida", type: "text" },
            { id: "filtroUnidadesComida", type: "number" },
            {
              id: "filtroEstadoComidaSelect",
              type: "select",
              defaultValue: "",
            },
          ],
          aplicarFn: aplicarFiltrosYOrdenarComida,
        });
        return;
      }
      [
        "buscarComida",
        "filtroUbicacionComida",
        "filtroEstadoProductoComida",
        "filtroUnidadesComida",
        "filtroEstadoComidaSelect",
      ].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.value = "";
      });
      aplicarFiltrosYOrdenarComida();
    }

    function ordenarPorFechaComida(e) {
      if (typeof ordenarPorFechaGenerico === "function")
        return ordenarPorFechaGenerico(e, "sortOptionsComida");
    }
    function ordenarAscendenteComida() {
      if (typeof ordenarAscendenteGenerico === "function")
        return ordenarAscendenteGenerico(
          aplicarFiltrosYOrdenarComida,
          "sortOptionsComida",
          (val) => (pageStateComida.fechaOrdenAscendente = val)
        );
    }
    function ordenarDescendenteComida() {
      if (typeof ordenarDescendenteGenerico === "function")
        return ordenarDescendenteGenerico(
          aplicarFiltrosYOrdenarComida,
          "sortOptionsComida",
          (val) => (pageStateComida.fechaOrdenAscendente = val)
        );
    }
    function toggleFiltrosAdicionalesComida() {
      if (typeof toggleFiltrosAdicionalesGenerico === "function")
        toggleFiltrosAdicionalesGenerico("filtrosAdicionalesContainer");
    }

    // =================================================
    // --- 7. ACCIONES Y UTILIDADES ---
    // =================================================
    function confirmarEliminarComida(id, nombreProducto) {
      if (!id) {
        mostrarMensaje("ID inválido para eliminar.", "error");
        return;
      }
      if (!confirm(`¿Seguro que deseas desactivar "${nombreProducto}"?`))
        return;
      showLoading(true);
      google.script.run
        .withSuccessHandler((resp) =>
          handleServerResponse(resp, null, loadComida)
        )
        .withFailureHandler(handleServerError)
        .eliminarComida(id);
    }

    function convertDaysToMonths(days) {
      return typeof days === "number" && days >= 0
        ? Math.floor(days / 30.44)
        : 0;
    }
    //--------
    
    //_________

    // =========================
    // 10) Inicialización y exposición global
    // =========================
    function inicializarPaginaComida() {
      const bind = (id, event, handler) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener(event, handler);
      };

      // Listeners para filtros
      bind("buscarComida", "input", aplicarFiltrosYOrdenarComida);
      bind("filtroUbicacionComida", "input", aplicarFiltrosYOrdenarComida);
      bind("filtroEstadoProductoComida", "input", aplicarFiltrosYOrdenarComida);
      bind("filtroUnidadesComida", "input", aplicarFiltrosYOrdenarComida);
      bind("filtroEstadoComidaSelect", "change", aplicarFiltrosYOrdenarComida);

      const toggleBtn = document.getElementById(
        "toggleFiltrosComidaIconContainer"
      );
      if (toggleBtn) {
        const cont = document.getElementById("filtrosAdicionalesContainer");
        if (cont) cont.classList.add("filtros-adicionales-ocultos");
        toggleBtn.addEventListener("click", toggleFiltrosAdicionalesComida);
      }

      // Listeners para tabs de notificaciones
      document
        .querySelectorAll("#modalVencimiento-Comida .tab-button[data-tab]")
        .forEach((button) => {
          button.addEventListener("click", function () {
            mostrarTab(this.dataset.tab, this);
          });
        });

      // Registrar cierre de modales con ESC
      registrarEscapeCierraModales([
        cerrarModalAgregarComida,
        cerrarModalEditarComida,
        cerrarModalRetiroComida,
        cerrarModalComentarioComida,
        cerrarModalVencimientoComida,
        cerrarModalNotificacionComentarioComida,
      ]);

      // Exponer funciones al scope global para que los `onclick` del HTML funcionen
      Object.assign(window, {
        // Modales
        abrirModalAgregarComida,
        cerrarModalAgregarComida,
        abrirModalEditarComida,
        cerrarModalEditarComida,
        abrirModalRetiroComida,
        cerrarModalRetiroComida,
        abrirModalComentarioComida,
        cerrarModalComentarioComida,
        abrirModalVencimientoComida,
        cerrarModalVencimientoComida,
        abrirModalNotificacionComentarioComida,
        cerrarModalNotificacionComentarioComida,
        // Acciones
        confirmarEliminarComida,
        limpiarNotificaciones,
        loadComentarios, // Exponer la función para recargar
        deactivateSelectedNotifications,
        handleIndividualCheckboxChange,
        // Filtros y orden
        aplicarFiltrosYOrdenarComida,
        limpiarTodosLosFiltrosComida,
        ordenarPorFechaComida,
        ordenarAscendenteComida,
        ordenarDescendenteComida,
        toggleFiltrosAdicionalesComida,
      });

      // iniciar carga
      loadComida();
    }

    inicializarPaginaComida();
  })();
</script>
